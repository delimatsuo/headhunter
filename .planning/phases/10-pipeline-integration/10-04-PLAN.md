---
phase: 10-pipeline-integration
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified:
  - services/hh-search-svc/src/search-service.ts
  - services/hh-search-svc/src/config.ts
autonomous: false

must_haves:
  truths:
    - "Retrieval stage returns 500+ candidates for typical queries"
    - "Scoring stage reduces to top 100"
    - "Reranking stage produces final top 50"
    - "End-to-end latency remains under p95 1.2s target"
  artifacts:
    - path: "services/hh-search-svc/src/search-service.ts"
      provides: "Complete 3-stage pipeline"
      contains: "STAGE 1: RETRIEVAL"
  key_links:
    - from: "services/hh-search-svc/src/search-service.ts"
      to: "services/hh-search-svc/src/config.ts"
      via: "pipeline config"
      pattern: "pipelineRetrievalLimit"
---

<objective>
Verify complete 3-stage pipeline operates end-to-end with proper stage handoffs.

Purpose: Validate the pipeline integration meets all Phase 10 success criteria: clear stage transitions, retrieval 500+, scoring top 100, reranking top 50, latency under 1.2s.

Output: Verified pipeline with human confirmation of correct behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/hh-search-svc/src/search-service.ts
@services/hh-search-svc/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Pipeline Configuration</name>
  <files>services/hh-search-svc/src/config.ts</files>
  <action>
Verify the perMethodLimit config is aligned with pipelineRetrievalLimit:

The perMethodLimit controls how many candidates each retrieval method (vector, FTS) returns before RRF fusion. To achieve 500+ total retrieval, perMethodLimit should be >= 300 (since RRF union may not fully double the count).

Check that current default or update if needed:
```typescript
perMethodLimit: Math.max(10, parseNumber(process.env.SEARCH_PER_METHOD_LIMIT, 300)),  // Increased from 100 to 300 for 500+ retrieval
```

This ensures:
- Vector search returns up to 300 candidates
- FTS returns up to 300 candidates
- RRF fusion produces 300-600 candidates (overlap dependent)
- Meets PIPE-02 requirement: retrieval focuses on recall (500+)

Note: If perMethodLimit is already >= 300, no change needed. If it's 100 (Phase 3 default), update to 300.
  </action>
  <verify>
Grep for "perMethodLimit" in config.ts and check the default value.
  </verify>
  <done>
perMethodLimit default is at least 300 to support 500+ retrieval.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and Type Check</name>
  <files>services/hh-search-svc/src/search-service.ts, services/hh-search-svc/src/config.ts</files>
  <action>
Run full build verification:

```bash
cd /Volumes/Extreme\ Pro/myprojects/headhunter/services/hh-search-svc
npm run build
```

Ensure all TypeScript compilation passes with no errors.

If any type errors, fix them before proceeding to verification checkpoint.
  </action>
  <verify>
`npm run build --prefix services/hh-search-svc` exits with code 0.
  </verify>
  <done>
TypeScript compilation passes for hh-search-svc.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 3-stage search pipeline with:
- Stage 1: Retrieval (hybrid search, target 500+ candidates)
- Stage 2: Scoring (signal weights, cutoff to top 100)
- Stage 3: Reranking (LLM via Gemini/Together AI, cutoff to top 50)

Pipeline logs at each stage transition showing counts and latencies.
Response includes pipelineMetrics with all stage data.
  </what-built>
  <how-to-verify>
1. Start the local development stack:
   ```bash
   cd /Volumes/Extreme\ Pro/myprojects/headhunter
   docker compose -f docker-compose.local.yml up hh-search-svc
   ```

2. Make a search request with includeDebug=true:
   ```bash
   curl -X POST http://localhost:7102/v1/search/hybrid \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer <your-token>" \
     -d '{
       "query": "senior software engineer python",
       "jobDescription": "We are looking for a senior software engineer with Python experience...",
       "includeDebug": true,
       "limit": 50
     }'
   ```

3. Check the logs for pipeline stage transitions:
   - Look for "STAGE 1: RETRIEVAL" with count near or above 500
   - Look for "STAGE 2: SCORING" with outputCount around 100
   - Look for "STAGE 3: RERANKING" with outputCount around 50
   - Look for "Pipeline complete" summary showing the funnel

4. Check the response includes pipelineMetrics:
   ```json
   {
     "pipelineMetrics": {
       "retrievalCount": 500+,
       "scoringCount": ~100,
       "rerankCount": ~50,
       "totalMs": <1200
     }
   }
   ```

5. Verify latency is under 1.2s (1200ms) for the request.

Expected behavior:
- Retrieval count: 500+ candidates
- Scoring count: ~100 candidates (after cutoff)
- Rerank count: ~50 candidates (final results)
- Total latency: <1200ms (p95 target)

Note: If database has fewer than 500 matching candidates, retrieval count may be lower - that's OK as long as the pipeline stages are working correctly.
  </how-to-verify>
  <resume-signal>
Type "approved" if pipeline stages are working correctly and latency is acceptable.
If issues found, describe what's not working (e.g., "retrieval only returning 50 candidates", "latency is 2.5s").
  </resume-signal>
</task>

</tasks>

<verification>
1. TypeScript builds successfully
2. Pipeline stages log at each transition
3. pipelineMetrics in response shows correct stage counts
4. Latency remains under p95 1.2s target
5. Human verification confirms pipeline funnel works as expected
</verification>

<success_criteria>
1. Search logs show clear stage transitions: retrieval count, scoring count, final count
2. Retrieval stage returns 500+ candidates for typical queries (recall-focused)
3. Scoring stage reduces to top 100 using signal weights (precision-focused)
4. Reranking stage uses LLM to produce final top 50 with nuanced ordering
5. End-to-end search latency remains under p95 1.2s target
</success_criteria>

<output>
After completion, create `.planning/phases/10-pipeline-integration/10-04-SUMMARY.md`
</output>
