---
phase: 10-pipeline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/hh-search-svc/src/config.ts
  - services/hh-search-svc/src/types.ts
autonomous: true

must_haves:
  truths:
    - "Search config exposes pipeline stage limits (retrieval, scoring, rerank)"
    - "Stage limits are configurable via environment variables"
    - "Default values match Phase 10 requirements (500/100/50)"
  artifacts:
    - path: "services/hh-search-svc/src/config.ts"
      provides: "Pipeline stage configuration"
      contains: "pipelineRetrievalLimit"
    - path: "services/hh-search-svc/src/types.ts"
      provides: "PipelineStageMetrics type"
      exports: ["PipelineStageMetrics"]
  key_links:
    - from: "services/hh-search-svc/src/config.ts"
      to: "SearchRuntimeConfig"
      via: "interface extension"
      pattern: "pipelineRetrievalLimit"
---

<objective>
Add pipeline stage configuration to enable the 3-stage search pipeline.

Purpose: Define configurable limits for each pipeline stage so retrieval (500+), scoring (top 100), and reranking (top 50) can be tuned per environment.

Output: Extended config with pipeline stage limits and types for pipeline metrics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/hh-search-svc/src/config.ts
@services/hh-search-svc/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pipeline Stage Configuration</name>
  <files>services/hh-search-svc/src/config.ts</files>
  <action>
Extend SearchRuntimeConfig interface to add pipeline stage configuration:

1. Add to SearchRuntimeConfig interface:
```typescript
// Pipeline stage limits (PIPE-01)
pipelineRetrievalLimit: number;  // Target retrieval count (default 500)
pipelineScoringLimit: number;    // Top N after scoring (default 100)
pipelineRerankLimit: number;     // Final top N after rerank (default 50)
pipelineLogStages: boolean;      // Log stage transitions (default true)
```

2. Add environment variable parsing in getSearchServiceConfig():
```typescript
pipelineRetrievalLimit: Math.max(100, parseNumber(process.env.PIPELINE_RETRIEVAL_LIMIT, 500)),
pipelineScoringLimit: Math.max(50, parseNumber(process.env.PIPELINE_SCORING_LIMIT, 100)),
pipelineRerankLimit: Math.max(10, parseNumber(process.env.PIPELINE_RERANK_LIMIT, 50)),
pipelineLogStages: parseBoolean(process.env.PIPELINE_LOG_STAGES, true),
```

Note: Use existing parseNumber and parseBoolean helpers. Apply Math.max guards to ensure sensible minimums.
  </action>
  <verify>
Run `npm run build --prefix services/hh-search-svc` - should compile without errors.
Grep for "pipelineRetrievalLimit" in config.ts to confirm presence.
  </verify>
  <done>
SearchRuntimeConfig has 4 new pipeline stage fields.
Environment variables PIPELINE_RETRIEVAL_LIMIT, PIPELINE_SCORING_LIMIT, PIPELINE_RERANK_LIMIT, PIPELINE_LOG_STAGES are read.
Defaults: 500/100/50/true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Pipeline Metrics Types</name>
  <files>services/hh-search-svc/src/types.ts</files>
  <action>
Add PipelineStageMetrics interface for tracking pipeline execution:

```typescript
/**
 * Pipeline stage metrics for debugging and SLO tracking.
 * @see PIPE-01: 3-stage pipeline logging requirement
 */
export interface PipelineStageMetrics {
  /** Stage 1: Retrieval - candidates returned from hybrid search */
  retrievalCount: number;
  retrievalMs: number;

  /** Stage 2: Scoring - candidates after signal weighting and cutoff */
  scoringCount: number;
  scoringMs: number;

  /** Stage 3: Reranking - final candidates after LLM rerank */
  rerankCount: number;
  rerankMs: number;

  /** Whether LLM reranking was applied (vs passthrough) */
  rerankApplied: boolean;

  /** Total pipeline latency */
  totalMs: number;
}
```

Add to HybridSearchResponse interface (or create new field):
```typescript
/** Pipeline execution metrics for stage debugging */
pipelineMetrics?: PipelineStageMetrics;
```
  </action>
  <verify>
Run `npm run build --prefix services/hh-search-svc` - should compile without errors.
Grep for "PipelineStageMetrics" in types.ts to confirm presence.
  </verify>
  <done>
PipelineStageMetrics interface exported from types.ts.
HybridSearchResponse includes optional pipelineMetrics field.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --prefix services/hh-search-svc` completes without errors
2. `grep -n "pipelineRetrievalLimit" services/hh-search-svc/src/config.ts` shows the new config fields
3. `grep -n "PipelineStageMetrics" services/hh-search-svc/src/types.ts` shows the new interface
</verification>

<success_criteria>
1. SearchRuntimeConfig has pipelineRetrievalLimit, pipelineScoringLimit, pipelineRerankLimit, pipelineLogStages fields
2. Environment variables are read with sensible defaults (500/100/50/true)
3. PipelineStageMetrics interface defines all stage metrics
4. HybridSearchResponse can include pipelineMetrics
5. TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-pipeline-integration/10-01-SUMMARY.md`
</output>
