---
phase: 10-pipeline-integration
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - services/hh-search-svc/src/search-service.ts
autonomous: true

must_haves:
  truths:
    - "HybridSearchResponse includes pipelineMetrics with all stage counts"
    - "Debug output includes pipeline stage breakdown"
    - "Pipeline metrics are available for monitoring/alerting"
  artifacts:
    - path: "services/hh-search-svc/src/search-service.ts"
      provides: "Pipeline metrics in response"
      contains: "pipelineMetrics"
  key_links:
    - from: "services/hh-search-svc/src/search-service.ts"
      to: "HybridSearchResponse.pipelineMetrics"
      via: "object construction"
      pattern: "pipelineMetrics:"
---

<objective>
Add pipeline metrics to search response for observability and debugging.

Purpose: Enable monitoring of pipeline stage counts and latencies for SLO tracking and debugging. Metrics show clear stage transitions for the 3-stage pipeline.

Output: HybridSearchResponse includes pipelineMetrics with retrieval/scoring/rerank counts and latencies.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/hh-search-svc/src/search-service.ts
@services/hh-search-svc/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track Pipeline Stage Metrics</name>
  <files>services/hh-search-svc/src/search-service.ts</files>
  <action>
At the start of hybridSearch(), initialize a metrics tracking object:

```typescript
// Pipeline metrics tracking
const pipelineMetrics = {
  retrievalCount: 0,
  retrievalMs: 0,
  scoringCount: 0,
  scoringMs: 0,
  rerankCount: 0,
  rerankMs: 0,
  rerankApplied: false,
  totalMs: 0
};
```

Update each stage to populate the metrics:

After Stage 1 (retrieval):
```typescript
pipelineMetrics.retrievalCount = rows.length;
pipelineMetrics.retrievalMs = retrievalMs;
```

After Stage 2 (scoring):
```typescript
pipelineMetrics.scoringCount = ranked.length;  // After cutoff
pipelineMetrics.scoringMs = scoringMs;
```

After Stage 3 (reranking):
```typescript
pipelineMetrics.rerankCount = ranked.length;  // After final cutoff
pipelineMetrics.rerankMs = rerankMs;
pipelineMetrics.rerankApplied = Boolean(rerankOutcome && !rerankOutcome.metadata?.usedFallback);
```

At the end:
```typescript
pipelineMetrics.totalMs = Date.now() - totalStart;
```
  </action>
  <verify>
Grep for "pipelineMetrics.retrievalCount" in search-service.ts.
  </verify>
  <done>
Pipeline metrics object tracks all 3 stages with counts and latencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Include Pipeline Metrics in Response</name>
  <files>services/hh-search-svc/src/search-service.ts</files>
  <action>
Add pipelineMetrics to the HybridSearchResponse construction:

```typescript
const response: HybridSearchResponse = {
  results: ranked.slice(0, limit),
  total: ranked.length,
  cacheHit: false,
  requestId: context.requestId,
  timings,
  metadata: {
    vectorWeight: this.config.search.vectorWeight,
    textWeight: this.config.search.textWeight,
    minSimilarity: this.config.search.minSimilarity,
    signalWeights: {
      roleType,
      weightsApplied: resolvedWeights
    }
  },
  // Pipeline stage metrics (PIPE-01)
  pipelineMetrics: {
    retrievalCount: pipelineMetrics.retrievalCount,
    retrievalMs: pipelineMetrics.retrievalMs,
    scoringCount: pipelineMetrics.scoringCount,
    scoringMs: pipelineMetrics.scoringMs,
    rerankCount: pipelineMetrics.rerankCount,
    rerankMs: pipelineMetrics.rerankMs,
    rerankApplied: pipelineMetrics.rerankApplied,
    totalMs: pipelineMetrics.totalMs
  }
};
```

Also add pipeline stage breakdown to debug output (if includeDebug is true):
```typescript
if (request.includeDebug) {
  response.debug = {
    // ... existing debug fields ...

    // Pipeline stage breakdown
    pipelineBreakdown: {
      stage1_retrieval: {
        count: pipelineMetrics.retrievalCount,
        target: this.config.search.pipelineRetrievalLimit,
        latencyMs: pipelineMetrics.retrievalMs
      },
      stage2_scoring: {
        inputCount: pipelineMetrics.retrievalCount,
        outputCount: pipelineMetrics.scoringCount,
        cutoff: this.config.search.pipelineScoringLimit,
        latencyMs: pipelineMetrics.scoringMs
      },
      stage3_rerank: {
        inputCount: pipelineMetrics.scoringCount,
        outputCount: pipelineMetrics.rerankCount,
        cutoff: this.config.search.pipelineRerankLimit,
        rerankApplied: pipelineMetrics.rerankApplied,
        latencyMs: pipelineMetrics.rerankMs
      }
    }
  };
}
```
  </action>
  <verify>
Grep for "pipelineMetrics:" in search-service.ts (in response construction).
Grep for "pipelineBreakdown" in search-service.ts (in debug output).
  </verify>
  <done>
HybridSearchResponse includes pipelineMetrics field.
Debug output includes detailed pipelineBreakdown with stage inputs/outputs/cutoffs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Pipeline Summary Log</name>
  <files>services/hh-search-svc/src/search-service.ts</files>
  <action>
Add a summary log at the end of hybridSearch() that shows the complete pipeline flow:

```typescript
// Pipeline summary log
this.logger.info(
  {
    requestId: context.requestId,
    tenantId: context.tenant.id,
    pipeline: {
      retrieval: pipelineMetrics.retrievalCount,
      afterScoring: pipelineMetrics.scoringCount,
      final: pipelineMetrics.rerankCount,
      rerankApplied: pipelineMetrics.rerankApplied
    },
    latency: {
      retrievalMs: pipelineMetrics.retrievalMs,
      scoringMs: pipelineMetrics.scoringMs,
      rerankMs: pipelineMetrics.rerankMs,
      totalMs: pipelineMetrics.totalMs
    },
    targets: {
      retrieval: this.config.search.pipelineRetrievalLimit,
      scoring: this.config.search.pipelineScoringLimit,
      rerank: this.config.search.pipelineRerankLimit
    }
  },
  'Pipeline complete: retrieval(%d) -> scoring(%d) -> rerank(%d)',
  pipelineMetrics.retrievalCount,
  pipelineMetrics.scoringCount,
  pipelineMetrics.rerankCount
);
```

This provides a single log line that shows the pipeline funnel at a glance.
  </action>
  <verify>
Grep for "Pipeline complete" in search-service.ts.
  </verify>
  <done>
Summary log shows pipeline funnel: retrieval -> scoring -> rerank counts.
Log includes latency breakdown and target configuration.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --prefix services/hh-search-svc` compiles without errors
2. `grep -n "pipelineMetrics:" services/hh-search-svc/src/search-service.ts` shows response field
3. `grep -n "pipelineBreakdown" services/hh-search-svc/src/search-service.ts` shows debug field
4. `grep -n "Pipeline complete" services/hh-search-svc/src/search-service.ts` shows summary log
</verification>

<success_criteria>
1. HybridSearchResponse includes pipelineMetrics with all stage data
2. Debug output includes pipelineBreakdown with stage inputs/outputs/cutoffs
3. Summary log shows complete pipeline funnel (retrieval -> scoring -> rerank)
4. Metrics include both counts and latencies for each stage
5. TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-pipeline-integration/10-03-SUMMARY.md`
</output>
