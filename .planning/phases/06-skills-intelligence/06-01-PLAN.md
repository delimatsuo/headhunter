---
phase: 06-skills-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/shared/skills-graph.ts
autonomous: true

must_haves:
  truths:
    - "Searching for Python returns candidates with Django or Flask skills"
    - "Related skills are returned with confidence scores (0-1)"
    - "Confidence decays with graph distance (direct=0.9, indirect=0.6)"
  artifacts:
    - path: "functions/src/shared/skills-graph.ts"
      provides: "BFS-based skill expansion with LRU caching"
      exports: ["expandSkills", "getCachedSkillExpansion", "SkillExpansionResult"]
  key_links:
    - from: "functions/src/shared/skills-graph.ts"
      to: "functions/src/shared/skills-master.ts"
      via: "imports MASTER_SKILLS and getSkillByName"
      pattern: "import.*MASTER_SKILLS.*from.*skills-master"
---

<objective>
Create a graph-based skill expansion module that uses BFS traversal of relatedSkillIds to find semantically related skills.

Purpose: Enable search to find candidates with related skills (e.g., "Python" search finds Django/Flask users) by leveraging the existing 468-skill taxonomy with relationship mappings.

Output: `functions/src/shared/skills-graph.ts` with BFS expansion, confidence scoring, and LRU caching.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skills-intelligence/06-RESEARCH.md
@functions/src/shared/skills-master.ts
@functions/src/shared/skills-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skills-graph.ts with BFS expansion</name>
  <files>functions/src/shared/skills-graph.ts</files>
  <action>
Create `functions/src/shared/skills-graph.ts` implementing:

1. **Types:**
```typescript
interface SkillExpansionResult {
  originalSkill: string;
  originalSkillId: string | null;
  relatedSkills: Array<{
    skillId: string;
    skillName: string;
    relationshipType: 'direct' | 'indirect';
    distance: number;  // Graph hops from original skill
    confidence: number; // 1.0 for direct, decays with distance
  }>;
}
```

2. **BFS expansion function:**
- `expandSkills(skillName: string, maxDepth: number = 2, maxResults: number = 10): SkillExpansionResult`
- Use BFS traversal via queue pattern
- Start with skill lookup via `getSkillByName()`
- Traverse `relatedSkillIds` from MASTER_SKILLS
- Track visited skills to prevent cycles
- Stop at maxDepth (default 2 hops)
- Limit results to maxResults (default 10)

3. **Confidence calculation:**
- `calculateConfidence(distance: number, marketDemand: string): number`
- Direct relationships (distance=1): base confidence 0.9
- Indirect relationships (distance=2): base confidence 0.6
- Boost 0.1 for 'critical' market demand skills
- Cap at 1.0

4. **LRU caching:**
- Use simple Map-based LRU cache (no external dependency)
- Cache key: `${skillName}:${maxDepth}`
- Cache size: 500 entries
- TTL: 1 hour (3600000ms)
- Export `getCachedSkillExpansion(skillName: string, maxDepth: number): SkillExpansionResult`

5. **Exports:**
- `expandSkills` - core BFS expansion
- `getCachedSkillExpansion` - cached version for hot paths
- `SkillExpansionResult` type
- `clearSkillExpansionCache()` - for testing

**Important:** Import from skills-master.ts directly for MASTER_SKILLS and getSkillByName. Do NOT use external graph libraries - implement simple BFS with queue.

**Log initialization:** Console log when module loads showing cache initialized.
  </action>
  <verify>
```bash
cd "/Volumes/Extreme Pro/myprojects/headhunter/functions"
npx tsc --noEmit
```
TypeScript compilation passes with no errors.
  </verify>
  <done>
- skills-graph.ts exists at functions/src/shared/skills-graph.ts
- Exports: expandSkills, getCachedSkillExpansion, SkillExpansionResult, clearSkillExpansionCache
- BFS traverses relatedSkillIds from skills-master.ts
- Confidence decays with distance (0.9 direct, 0.6 indirect)
- LRU cache implemented with 500 entry limit
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bidirectional relationship support</name>
  <files>functions/src/shared/skills-graph.ts</files>
  <action>
Enhance skills-graph.ts to build an inverted index for bidirectional relationship traversal at module load:

1. **Build inverted index at module initialization:**
```typescript
// Build at module load (once)
const REVERSE_RELATIONSHIPS = new Map<string, Set<string>>();

for (const skill of MASTER_SKILLS) {
  if (skill.relatedSkillIds) {
    for (const relatedId of skill.relatedSkillIds) {
      if (!REVERSE_RELATIONSHIPS.has(relatedId)) {
        REVERSE_RELATIONSHIPS.set(relatedId, new Set());
      }
      REVERSE_RELATIONSHIPS.get(relatedId)!.add(skill.id);
    }
  }
}
```

2. **Modify BFS to use bidirectional relationships:**
- When traversing from a skill, include BOTH:
  - Forward: skill.relatedSkillIds (Python -> Django)
  - Backward: REVERSE_RELATIONSHIPS.get(skill.id) (Django -> Python)
- This ensures "Django" search also finds "Python" users

3. **Log initialization:**
- Log count of forward relationships
- Log count of reverse relationships built

4. **Export for testing:**
- `getRelatedSkillIds(skillId: string): string[]` - returns combined forward+backward related skill IDs
  </action>
  <verify>
```bash
cd "/Volumes/Extreme Pro/myprojects/headhunter/functions"
npx tsc --noEmit
```
TypeScript compilation passes.
  </verify>
  <done>
- REVERSE_RELATIONSHIPS Map built at module load
- BFS uses both forward and backward relationships
- "Django" expansion includes "Python" (bidirectional)
- getRelatedSkillIds() exported for testing
- Initialization log shows forward and reverse relationship counts
  </done>
</task>

<task type="auto">
  <name>Task 3: Export module from skills-service.ts</name>
  <files>functions/src/shared/skills-service.ts</files>
  <action>
Add re-exports from skills-service.ts to make skills-graph.ts accessible via the existing service facade:

1. Add to skills-service.ts:
```typescript
// Re-export skill expansion functions
export {
  expandSkills,
  getCachedSkillExpansion,
  getRelatedSkillIds,
  clearSkillExpansionCache,
  type SkillExpansionResult
} from './skills-graph';
```

This allows consumers to import everything from skills-service.ts:
```typescript
import {
  normalizeSkillName,
  expandSkills,
  getCachedSkillExpansion
} from './shared/skills-service';
```
  </action>
  <verify>
```bash
cd "/Volumes/Extreme Pro/myprojects/headhunter/functions"
npx tsc --noEmit
```
TypeScript compilation passes.
  </verify>
  <done>
- skills-service.ts re-exports expandSkills, getCachedSkillExpansion, getRelatedSkillIds, clearSkillExpansionCache, SkillExpansionResult
- Single import point for all skill-related functions
- TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd functions && npx tsc --noEmit`
2. Module loads without error: `node -e "require('./lib/shared/skills-graph')" 2>&1 | head -5`
3. Expansion works: Check console logs show initialization with relationship counts
</verification>

<success_criteria>
1. skills-graph.ts exists with BFS expansion, confidence decay, and LRU caching
2. Bidirectional relationships supported (Django -> Python works)
3. All functions exported via skills-service.ts
4. TypeScript compiles cleanly
5. Module initialization logs show cache ready and relationship counts
</success_criteria>

<output>
After completion, create `.planning/phases/06-skills-intelligence/06-01-SUMMARY.md`
</output>
