---
phase: 01-reranking-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - headhunter-ui/src/services/api.ts
autonomous: true

must_haves:
  truths:
    - "Frontend displays distinct Match and Similarity scores that differ by >1% for 90% of results"
    - "When user searches, they see two different percentage badges on candidate cards"
    - "API response mapping correctly extracts raw_vector_similarity from match_metadata"
  artifacts:
    - path: "headhunter-ui/src/services/api.ts"
      provides: "Correct score extraction from backend response"
      contains: "raw_vector_similarity"
  key_links:
    - from: "backend match_metadata.raw_vector_similarity"
      to: "headhunter-ui/src/services/api.ts"
      via: "response mapping"
      pattern: "match_metadata.*raw_vector_similarity"
---

<objective>
Fix the frontend API service to correctly extract and pass both scores from the backend response.

Purpose: The api.ts service currently has a fallback chain that uses `overall_score` when `vector_similarity_score` is missing. Now that Plan 01 has fixed the backend to expose `raw_vector_similarity` in match_metadata, we need to update the frontend to read from this correct location.

Output: API service that correctly maps both scores (match score AND similarity) to separate fields for display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-reranking-fix/01-01-SUMMARY.md

# Key source files
@headhunter-ui/src/services/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix similarity extraction in searchWithEngine response mapping (line ~425)</name>
  <files>headhunter-ui/src/services/api.ts</files>
  <action>
Find the response mapping in searchWithEngine around line 423-436. The current code is:

```typescript
return {
    candidate,
    score: c.overall_score / 100,
    similarity: c.vector_similarity_score,
    // ...
};
```

Change it to correctly extract similarity from match_metadata:

```typescript
return {
    candidate,
    score: c.overall_score / 100, // LLM-influenced match score (0-1 scale)
    similarity: (c.match_metadata?.raw_vector_similarity || c.vector_similarity_score || 0) / 100, // Raw vector similarity (0-1 scale)
    rationale: {
        overall_assessment: c.rationale && c.rationale.length > 0
            ? c.rationale.join('. ') + '.'
            : `Matched with ${(c.overall_score).toFixed(0)}% score based on skills and experience.`,
        strengths: c.rationale || [],
        gaps: [],
        risk_factors: []
    }
};
```

The key change is:
- `similarity` now reads from `match_metadata.raw_vector_similarity` first (the preserved raw score)
- Falls back to `vector_similarity_score` if present (legacy support)
- Falls back to 0 if neither exists (never falls back to overall_score)
- Divides by 100 to normalize to 0-1 scale (raw_vector_similarity is 0-100 from backend)
  </action>
  <verify>
Run: `grep -n "raw_vector_similarity" headhunter-ui/src/services/api.ts`
Should show the field being extracted around line 425.
  </verify>
  <done>
The searchWithEngine response mapping extracts similarity from match_metadata.raw_vector_similarity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix similarity extraction in legacy search response mapping (line ~927)</name>
  <files>headhunter-ui/src/services/api.ts</files>
  <action>
Find the second response mapping around line 926-934. The current code is:

```typescript
score: c.overall_score,
similarity: c.vector_similarity_score || c.overall_score,  // BUG: fallback to overall_score
```

Change it to:

```typescript
score: c.overall_score,  // LLM-influenced match score (already 0-100)
similarity: c.match_metadata?.raw_vector_similarity || c.vector_similarity_score || 0,  // Raw vector similarity (0-100)
```

This removes the fallback chain that was masking the bug. Now:
- `score` = LLM-influenced overall_score
- `similarity` = raw vector similarity from match_metadata (never overall_score)

DO NOT use overall_score as a fallback for similarity - this was the core bug.
  </action>
  <verify>
Run: `grep -n "similarity:.*overall_score" headhunter-ui/src/services/api.ts`
Should return NO results - the fallback to overall_score should be removed.
  </verify>
  <done>
The legacy response mapping extracts similarity from match_metadata.raw_vector_similarity without falling back to overall_score.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add debug logging to verify score differentiation</name>
  <files>headhunter-ui/src/services/api.ts</files>
  <action>
Add temporary debug logging in both response mappings to verify scores differ. This helps with testing.

In the searchWithEngine mapping (after the return block, around line 437), add:

```typescript
// Debug: Log score differentiation (remove after verification)
if (matches.length > 0) {
    const sampleMatch = matches[0];
    console.log(`[API Debug] First result scores - Match: ${sampleMatch.score?.toFixed(2)}, Similarity: ${sampleMatch.similarity?.toFixed(2)}, Different: ${sampleMatch.score !== sampleMatch.similarity}`);
}
```

In the legacy mapping (around line 935), add similar logging:

```typescript
// Debug: Log score differentiation (remove after verification)
if (matches.length > 0) {
    const sampleMatch = matches[0];
    console.log(`[API Debug] First result scores - Match: ${sampleMatch.score?.toFixed(2)}, Similarity: ${sampleMatch.similarity?.toFixed(2)}, Different: ${Math.abs((sampleMatch.score || 0) - (sampleMatch.similarity || 0)) > 0.01}`);
}
```

Mark these with `// TODO: Remove after Phase 1 verification` so they can be cleaned up.
  </action>
  <verify>
Run: `grep -n "API Debug" headhunter-ui/src/services/api.ts`
Should show debug logging in both response mapping locations.
  </verify>
  <done>
Debug logging is added to verify score differentiation during testing.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the frontend:
   ```bash
   cd headhunter-ui && npm run build
   ```
   Should compile without TypeScript errors.

2. Verify no overall_score fallback for similarity:
   ```bash
   grep -n "similarity:.*overall_score" headhunter-ui/src/services/api.ts
   ```
   Should return NO results.

3. Verify raw_vector_similarity extraction:
   ```bash
   grep -n "raw_vector_similarity" headhunter-ui/src/services/api.ts
   ```
   Should show 2+ occurrences (both mapping locations).

4. Verify debug logging exists:
   ```bash
   grep -n "API Debug" headhunter-ui/src/services/api.ts
   ```
   Should show 2 occurrences.
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. `similarity` field is extracted from `match_metadata.raw_vector_similarity` in both response mappings
3. No fallback chain uses `overall_score` as similarity
4. Debug logging is in place to verify score differentiation
5. Scores are correctly normalized (0-1 scale for frontend display)
</success_criteria>

<output>
After completion, create `.planning/phases/01-reranking-fix/01-02-SUMMARY.md`
</output>
