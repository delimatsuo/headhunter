---
phase: 01-reranking-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/engines/legacy-engine.ts
  - functions/src/vector-search.ts
autonomous: true

must_haves:
  truths:
    - "Raw vector similarity score is preserved from vector search through entire pipeline"
    - "Vector similarity score appears in match_metadata as a distinct field from overall_score"
    - "Candidates have two different score values: vector similarity and overall match score"
  artifacts:
    - path: "functions/src/engines/legacy-engine.ts"
      provides: "Score preservation through transformation chain"
      contains: "_raw_vector_similarity"
    - path: "functions/src/vector-search.ts"
      provides: "Vector similarity source"
      contains: "vector_similarity_score"
  key_links:
    - from: "functions/src/vector-search.ts"
      to: "functions/src/engines/legacy-engine.ts"
      via: "vectorSearchResults parameter"
      pattern: "_raw_vector_similarity|vector_similarity_score"
---

<objective>
Fix the score propagation bug in the backend where raw vector similarity gets lost.

Purpose: The vector search correctly computes vector_similarity_score, but legacy-engine.ts loses this value during candidate transformations. This plan preserves the raw similarity through the entire transformation chain so both scores (raw vector similarity AND LLM-influenced match score) are available in the response.

Output: Backend functions that correctly preserve and expose both score types in the API response.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-reranking-fix/01-RESEARCH.md

# Key source files
@functions/src/engines/legacy-engine.ts
@functions/src/vector-search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preserve raw vector similarity in legacy-engine.ts vectorPool initialization</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
At line 146, WRAP the existing vectorPool assignment with a `.map()` transformation to preserve the raw similarity score.

**BEFORE (line 146):**
```typescript
let vectorPool: any[] = vectorSearchResults || [];
```

**AFTER:**
```typescript
let vectorPool: any[] = (vectorSearchResults || []).map((c: any) => ({
    ...c,
    _raw_vector_similarity: c.vector_similarity_score || c.similarity_score || 0
}));
```

This wraps the existing array assignment with a map that:
1. Spreads all existing candidate properties (`...c`)
2. Adds `_raw_vector_similarity` field capturing the raw vector score from vector-search.ts

The raw vector similarity from vector-search.ts (which sets `vector_similarity_score` at line 839) is preserved under a new private field `_raw_vector_similarity` that won't be confused with other score fields.

Do NOT modify the existing vector-search.ts - it already correctly sets `vector_similarity_score`.
  </action>
  <verify>
Run: `grep -n "_raw_vector_similarity" functions/src/engines/legacy-engine.ts`
Should show the field being set in vectorPool initialization.
  </verify>
  <done>
The `_raw_vector_similarity` field is set when vectorPool is initialized from vectorSearchResults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Propagate raw similarity through candidate transformations</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
The legacy-engine.ts has multiple places where candidates are transformed. Ensure `_raw_vector_similarity` is preserved in each:

1. In the `rerankedTop` mapping (around line 572), add the field:
```typescript
return {
    ...c,
    overall_score: overallScore,
    gemini_score: geminiScore,
    _raw_vector_similarity: c._raw_vector_similarity || 0,  // Preserve raw similarity
    rationale
};
```

2. In the `remainingCandidates` mapping (around line 580), add the field:
```typescript
const remainingCandidates = candidates.slice(50).map((c: any) => ({
    ...c,
    overall_score: c.retrieval_score || 0,
    _raw_vector_similarity: c._raw_vector_similarity || 0,  // Preserve raw similarity
    rationale: ['Additional match']
}));
```

3. In the error fallback mapping (around line 592), add the field:
```typescript
candidates = candidates.map((c: any) => ({
    ...c,
    overall_score: c.retrieval_score || 0,
    _raw_vector_similarity: c._raw_vector_similarity || 0,  // Preserve raw similarity
    rationale: c.sources?.includes('function')
        ? [`Matching ${targetClassification.function} function`]
        : ['Relevant background']
}));
```

4. In the fallback candidates mapping (around line 641), add the field:
```typescript
.map((c: any) => ({
    ...c,
    overall_score: 25,
    _raw_vector_similarity: c._raw_vector_similarity || c.vector_similarity_score || 0,
    rationale: ['Vector similarity match (fallback)'],
    sources: ['vector_fallback'],
    search_mode: searchMode
}));
```
  </action>
  <verify>
Run: `grep -c "_raw_vector_similarity" functions/src/engines/legacy-engine.ts`
Should show at least 5 occurrences (1 initialization + 4 transformations).
  </verify>
  <done>
The `_raw_vector_similarity` field is preserved through all candidate transformation chains.
  </done>
</task>

<task type="auto">
  <name>Task 3: Expose raw similarity in match_metadata and response</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
In the final matches construction (around line 654), fix the match_metadata to include the preserved raw similarity:

Change:
```typescript
match_metadata: {
    sources: c.sources,
    score_breakdown: c.score_breakdown,
    vertex_score: c.vertex_score,
    vector_score: c.vertex_score, // BUG: This is undefined/wrong
    target_function: targetClassification.function,
    target_level: targetClassification.level,
    candidate_function: c.searchable?.function
}
```

To:
```typescript
match_metadata: {
    sources: c.sources,
    score_breakdown: c.score_breakdown,
    vertex_score: c.vertex_score,
    vector_score: c._raw_vector_similarity || 0,  // FIXED: Use preserved raw similarity
    raw_vector_similarity: c._raw_vector_similarity || 0,  // Explicit field for frontend
    gemini_score: c.gemini_score || 0,  // Include Gemini score for debugging
    target_function: targetClassification.function,
    target_level: targetClassification.level,
    candidate_function: c.searchable?.function
}
```

Also add logging to verify scores differ:
```typescript
// Add before the return statement at line 678
console.log(`[LegacyEngine] Score sample: overall=${matches[0]?.score || 0}, raw_vector=${matches[0]?.match_metadata?.raw_vector_similarity || 0}, gemini=${matches[0]?.match_metadata?.gemini_score || 0}`);
```
  </action>
  <verify>
Run: `grep -n "raw_vector_similarity" functions/src/engines/legacy-engine.ts | tail -5`
Should show the field being set in match_metadata.
  </verify>
  <done>
The match_metadata includes `raw_vector_similarity` with the preserved raw vector search score, distinct from `overall_score`.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the functions:
   ```bash
   cd functions && npm run build
   ```
   Should compile without TypeScript errors.

2. Verify field preservation:
   ```bash
   grep -n "_raw_vector_similarity\|raw_vector_similarity" functions/src/engines/legacy-engine.ts
   ```
   Should show the field in:
   - vectorPool initialization
   - rerankedTop mapping
   - remainingCandidates mapping
   - error fallback mapping
   - fallback candidates mapping
   - match_metadata construction

3. Count occurrences:
   ```bash
   grep -c "_raw_vector_similarity" functions/src/engines/legacy-engine.ts
   ```
   Should be >= 6 (initialization + 4 transformations + match_metadata)
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. `_raw_vector_similarity` field is preserved through all candidate transformations
3. `match_metadata.raw_vector_similarity` is set to the preserved raw vector similarity
4. `match_metadata.gemini_score` is set for debugging
5. Logging shows both scores for verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-reranking-fix/01-01-SUMMARY.md`
</output>
