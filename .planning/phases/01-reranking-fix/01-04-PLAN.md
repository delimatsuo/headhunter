---
phase: 01-reranking-fix
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css
autonomous: false
# Note: Tasks 1-2 execute autonomously. Execution pauses at Task 3 checkpoint for human verification.

must_haves:
  truths:
    - "Match Score displays 90%+ different from Similarity Score across search results"
    - "LLM reranking is verified working through visual inspection of score differences"
    - "Rerank latency remains under 500ms per batch"
  artifacts:
    - path: "headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css"
      provides: "Visual styling for dual score badges"
      contains: "score-badge.similarity"
  key_links:
    - from: "Search UI"
      to: "Backend reranking"
      via: "Score differentiation visible"
      pattern: "Match != Similarity for 90%+ results"
---

<objective>
Add CSS styling for the dual score badges and verify the complete fix end-to-end.

Purpose: This is the final plan that adds visual polish (CSS styling for the new similarity badge) and includes a human verification checkpoint to confirm the reranking fix is working correctly in the running application.

Output: Styled score badges and verified confirmation that Match Score != Similarity Score for 90%+ of results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-reranking-fix/01-01-SUMMARY.md
@.planning/phases/01-reranking-fix/01-02-SUMMARY.md
@.planning/phases/01-reranking-fix/01-03-SUMMARY.md

# Key source files
@headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS for dual score badge display</name>
  <files>headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css</files>
  <action>
Add CSS styles for the score badges container and the similarity badge variant. Find the existing score badge styles (search for `.score-badge` or similar) and add these styles:

```css
/* Score badges container - horizontal layout */
.score-badges {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

/* Base score badge styling (may already exist, extend if so) */
.score-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

/* Match score badge (primary - LLM influenced) */
.score-badge.match {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.score-badge.match.excellent {
    background-color: #c8e6c9;
    border-color: #66bb6a;
}

.score-badge.match.good {
    background-color: #dcedc8;
    border-color: #9ccc65;
}

.score-badge.match.fair {
    background-color: #fff3e0;
    border-color: #ffb74d;
    color: #e65100;
}

.score-badge.match.poor {
    background-color: #ffebee;
    border-color: #ef9a9a;
    color: #c62828;
}

/* Similarity score badge (secondary - raw vector) */
.score-badge.similarity {
    background-color: #e3f2fd;
    color: #1565c0;
    border: 1px solid #90caf9;
    font-size: 11px;
    padding: 3px 8px;
}

.score-badge.similarity.excellent {
    background-color: #bbdefb;
    border-color: #42a5f5;
}

.score-badge.similarity.good {
    background-color: #e1f5fe;
    border-color: #4fc3f7;
}

.score-badge.similarity.fair {
    background-color: #fff8e1;
    border-color: #ffd54f;
    color: #f57f17;
}

.score-badge.similarity.poor {
    background-color: #fce4ec;
    border-color: #f48fb1;
    color: #ad1457;
}
```

Key design decisions:
- Match badge is green (primary action color) - larger
- Similarity badge is blue (secondary info color) - slightly smaller
- Color coding for excellent/good/fair/poor applies to both
- Flex container allows responsive wrapping on small screens
  </action>
  <verify>
Run: `grep -n "score-badge.similarity" headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css`
Should show the similarity badge CSS rules.
  </verify>
  <done>
CSS styling for dual score badges is in place with distinct colors for Match (green) and Similarity (blue).
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and start the development environment</name>
  <files>N/A (deployment)</files>
  <action>
Build and start both the backend and frontend for testing using docker-compose for local development:

1. Build and start the backend services:
   ```bash
   docker compose -f docker-compose.local.yml up --build
   ```
   This starts all backend services including hh-search-svc with the updated code.

2. Start the frontend dev server (in a separate terminal):
   ```bash
   cd headhunter-ui && npm run dev
   ```

3. Wait for all services to be healthy. Check with:
   ```bash
   for port in 7101 7102 7103 7104 7105 7106 7107 7108; do
     curl -sf localhost:$port/health && echo " - Port $port OK" || echo " - Port $port FAILED"
   done
   ```

The goal is to have both backend (docker-compose) and frontend (npm dev server) running with the changes from Plans 01-03.
  </action>
  <verify>
Frontend accessible at http://localhost:3000 (Vite dev server)
Backend services healthy on ports 7101-7108
Search request returns results (check network tab for /search endpoint)
  </verify>
  <done>
Development environment is running with all changes from Plans 01-03.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete reranking fix across backend and frontend:
1. Backend preserves raw vector similarity through transformation chain
2. API service correctly extracts both scores without fallback masking
3. UI displays both Match Score (LLM-influenced) and Similarity Score (raw vector)
4. CSS styling differentiates the two score types
  </what-built>
  <how-to-verify>
1. Open the search UI (http://localhost:3000 or production URL)

2. Perform a search query (e.g., "Python developer", "Engineering Manager")

3. Look at the candidate cards in the results:
   - **Expected:** Each card shows TWO score badges
     - Green "Match: XX%" badge (LLM-influenced score)
     - Blue "Sim: XX%" badge (raw vector similarity)
   - **Expected:** The two scores should be DIFFERENT for most candidates
     - If both scores are identical, the fix is NOT working

4. Open browser DevTools Console and look for:
   - `[API Debug]` log showing "Different: true" for most results
   - `[LegacyEngine]` log (in Firebase/Cloud Functions logs) showing different overall and raw_vector scores

5. Count the results where scores differ:
   - At least 90% of results should have Match Score != Similarity Score
   - The difference should typically be 5-20% (Gemini reranking adjustment)

6. Verify ranking order reflects reranking (not just raw vector similarity):
   - Look at the top 5 results - their order should reflect LLM evaluation
   - A candidate with lower Similarity but higher Match should appear ABOVE a candidate with higher Similarity but lower Match
   - If results are ordered purely by Similarity score, reranking is not affecting order

7. Verify rerank latency:
   - Check network tab for the search request timing
   - Total search should complete under 2s
   - Rerank step (if logged separately) should be under 500ms

8. Verify ranking changes are meaningful:
   - Compare the ranking order by Match Score vs Similarity Score
   - At least some candidates should have different positions in the two orderings
   - Strong qualitative fit (high Match, moderate Similarity) should rank higher than pure keyword match (high Similarity, moderate Match)

**If scores are IDENTICAL for all results:** The fix is NOT working. Check:
- Console for errors
- Network response to see if raw_vector_similarity is present in match_metadata
- Backend logs for score propagation messages
  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" - Scores differ for 90%+ of results, reranking confirmed working
- "partial: [description]" - Some issues found, describe what's working vs not
- "failed: [description]" - Scores are identical or other blocking issue
  </resume-signal>
</task>

</tasks>

<verification>
Before the human checkpoint:

1. Verify CSS compiled:
   ```bash
   cd headhunter-ui && npm run build
   ```

2. Verify all files modified across the phase:
   ```bash
   git diff --stat HEAD~4
   ```
   Should show changes to:
   - functions/src/engines/legacy-engine.ts
   - headhunter-ui/src/services/api.ts
   - headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.tsx
   - headhunter-ui/src/components/Search/SearchResults.tsx
   - headhunter-ui/src/components/Candidate/SkillAwareCandidateCard.css
</verification>

<success_criteria>
1. CSS styling applied correctly (green Match, blue Sim badges)
2. Application builds and runs without errors
3. **CRITICAL:** Match Score differs from Similarity Score for 90%+ of search results
4. LLM reranking response is visible in console/logs
5. Rerank latency under 500ms per batch
6. Human verification confirms the fix is working
</success_criteria>

<output>
After completion and human verification, create `.planning/phases/01-reranking-fix/01-04-SUMMARY.md` with verification results.
</output>
