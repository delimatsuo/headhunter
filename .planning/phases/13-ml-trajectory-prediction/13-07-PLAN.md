---
phase: 13-ml-trajectory-prediction
plan: 07
type: execute
wave: 4
depends_on: ["13-05", "13-06"]
files_modified:
  - services/hh-trajectory-svc/src/routes/predict.test.ts
  - services/hh-trajectory-svc/src/inference/trajectory-predictor.test.ts
  - services/hh-trajectory-svc/src/shadow/shadow-mode.test.ts
  - services/hh-search-svc/src/ml-trajectory-client.test.ts
  - docker-compose.local.yml
autonomous: true

must_haves:
  truths:
    - "All unit tests pass for hh-trajectory-svc"
    - "Integration test verifies end-to-end prediction flow"
    - "Shadow mode comparison logging is verified"
    - "Circuit breaker behavior is tested"
  artifacts:
    - path: "services/hh-trajectory-svc/src/routes/predict.test.ts"
      provides: "Predict route unit tests"
      contains: "describe.*predict"
    - path: "services/hh-trajectory-svc/src/inference/trajectory-predictor.test.ts"
      provides: "Predictor unit tests with mock ONNX"
      contains: "TrajectoryPredictor"
    - path: "services/hh-search-svc/src/ml-trajectory-client.test.ts"
      provides: "HTTP client tests with circuit breaker"
      contains: "circuitBreaker"
  key_links:
    - from: "services/hh-trajectory-svc/src/routes/predict.test.ts"
      to: "services/hh-trajectory-svc/src/routes/predict.ts"
      via: "test target"
      pattern: "import.*predict"
---

<objective>
Create comprehensive test suite and verify Phase 13 completion against all requirements

Purpose: Ensure ML trajectory prediction system is production-ready with proper test coverage. Verify all 5 requirements (TRAJ-05 to TRAJ-09) are met with evidence.

Output: Passing test suite and verification documentation for Phase 13.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ml-trajectory-prediction/13-RESEARCH.md
@.planning/phases/13-ml-trajectory-prediction/13-05-SUMMARY.md
@.planning/phases/13-ml-trajectory-prediction/13-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hh-trajectory-svc unit tests</name>
  <files>
    services/hh-trajectory-svc/src/routes/predict.test.ts
    services/hh-trajectory-svc/src/inference/trajectory-predictor.test.ts
    services/hh-trajectory-svc/src/shadow/shadow-mode.test.ts
  </files>
  <action>
Create comprehensive unit tests for hh-trajectory-svc:

1. Create `services/hh-trajectory-svc/src/routes/predict.test.ts`:
   - Test suite: "POST /predict"
     - "returns prediction for valid request"
     - "returns 400 for missing candidateId"
     - "returns 400 for empty titleSequence"
     - "returns 503 when model not initialized"
     - "includes lowConfidence flag when confidence < 0.6"
     - "includes uncertaintyReason for short sequences"
   - Mock TrajectoryPredictor for route tests

2. Create `services/hh-trajectory-svc/src/inference/trajectory-predictor.test.ts`:
   - Test suite: "TrajectoryPredictor"
     - "initializes successfully with mock model"
     - "encodes title sequences correctly"
     - "applies softmax to logits"
     - "calibrates confidence scores"
     - "returns lowConfidence for < 0.6 calibrated confidence"
     - "generates uncertainty reasons":
       - "Limited career history" for sequence length < 3
       - "Unusual career pattern" for high entropy
       - "Ambiguous next role" for close top-2 predictions
   - Mock ONNX session with predictable outputs

3. Create `services/hh-trajectory-svc/src/shadow/shadow-mode.test.ts`:
   - Test suite: "ShadowMode"
     - "logs comparison when enabled"
     - "skips logging when disabled"
     - "computes direction agreement correctly"
     - "computes velocity agreement correctly"
     - "computes type agreement correctly"
     - "returns correct stats"
   - Test suite: "ComparisonLogger"
     - "batches logs correctly"
     - "flushes when batch size reached"
     - "calculates agreement percentages"
   - Use in-memory storage for tests
  </action>
  <verify>
    - `npm run test --workspace=@hh/hh-trajectory-svc`
  </verify>
  <done>hh-trajectory-svc has comprehensive unit test coverage</done>
</task>

<task type="auto">
  <name>Task 2: Create hh-search-svc ML client tests</name>
  <files>
    services/hh-search-svc/src/ml-trajectory-client.test.ts
  </files>
  <action>
Create ML trajectory client tests:

1. Create `services/hh-search-svc/src/ml-trajectory-client.test.ts`:
   - Test suite: "MLTrajectoryClient"
     - "returns prediction on success"
     - "returns null on timeout"
     - "returns null on connection error"
     - "opens circuit breaker after 3 failures"
     - "returns null immediately when circuit open"
     - "closes circuit breaker after 30 seconds"
     - "reports availability correctly"
   - Test suite: "Integration with scoring"
     - "attaches ML prediction to candidate"
     - "continues scoring if prediction fails"
     - "logs disagreement between ML and rule-based"

   - Use mock HTTP server (msw or nock) for tests
   - Test circuit breaker state transitions
   - Verify timeout handling (use fake timers)
  </action>
  <verify>
    - `npm run test --workspace=@hh/hh-search-svc` (should include new tests)
  </verify>
  <done>ML trajectory client has circuit breaker and timeout tests</done>
</task>

<task type="auto">
  <name>Task 3: Update docker-compose and verify requirements</name>
  <files>
    docker-compose.local.yml
    .planning/phases/13-ml-trajectory-prediction/13-VERIFICATION.md
  </files>
  <action>
Update local development stack and document verification:

1. Update `docker-compose.local.yml`:
   - Add hh-trajectory-svc service:
     ```yaml
     hh-trajectory-svc:
       build:
         context: ./services/hh-trajectory-svc
         dockerfile: Dockerfile
       ports:
         - "7109:7109"
       environment:
         - NODE_ENV=development
         - PORT=7109
         - SHADOW_MODE_ENABLED=true
         - MODEL_PATH=/app/models/trajectory-lstm.onnx
       volumes:
         - ./models:/app/models:ro
       healthcheck:
         test: ["CMD", "curl", "-f", "http://localhost:7109/health"]
         interval: 30s
         timeout: 10s
         retries: 3
       depends_on:
         - redis
     ```
   - Add to depends_on for hh-search-svc

2. Create `13-VERIFICATION.md`:
   Document requirement verification:

   ### TRAJ-05: Next role prediction with confidence score
   - Evidence: TrajectoryPrediction component displays "Senior Engineer -> Staff Engineer (78%)"
   - Code: `services/hh-trajectory-svc/src/inference/trajectory-predictor.ts`
   - Test: `trajectory-predictor.test.ts` "returns prediction for valid request"
   - Status: PASS

   ### TRAJ-06: Tenure prediction
   - Evidence: UI displays "Likely to stay 18-24 months"
   - Code: `services/hh-trajectory-svc/src/inference/trajectory-predictor.ts` (tenure_head)
   - Test: "includes tenure prediction in response"
   - Status: PASS

   ### TRAJ-07: Model confidence indicators
   - Evidence: Low confidence shows warning banner with uncertainty reason
   - Code: ConfidenceIndicator.tsx, TrajectoryPrediction.tsx
   - Threshold: < 60% triggers warning per RESEARCH.md
   - Test: "includes lowConfidence flag when confidence < 0.6"
   - Status: PASS

   ### TRAJ-08: Shadow mode deployment
   - Evidence: /shadow/stats endpoint returns agreement metrics
   - Code: `services/hh-trajectory-svc/src/shadow/shadow-mode.ts`
   - Promotion criteria: >85% direction, >80% velocity, >1000 comparisons
   - Test: shadow-mode.test.ts "returns correct stats"
   - Status: PASS

   ### TRAJ-09: Hireability prediction
   - Evidence: UI displays "High likelihood to join: startup experience, growth trajectory"
   - Code: hireability_head in LSTM model
   - Test: "includes hireability in response"
   - Status: PASS

   ### Success Criteria Verification:
   1. "Senior Engineer -> Staff Engineer (78%)" - TrajectoryPrediction component
   2. "Likely to stay 18-24 months" - tenure display
   3. Warning for < 60% confidence - ConfidenceIndicator warning state
   4. Shadow logs comparison - /shadow/stats endpoint
   5. Hireability score - TrajectoryPrediction hireability section
  </action>
  <verify>
    - `docker compose -f docker-compose.local.yml config` (validate yaml)
    - Review 13-VERIFICATION.md for completeness
    - Run all tests: `npm test --prefix services`
  </verify>
  <done>Docker compose updated, all 5 requirements verified with evidence</done>
</task>

</tasks>

<verification>
1. All hh-trajectory-svc tests pass: `npm run test --workspace=@hh/hh-trajectory-svc`
2. All hh-search-svc tests pass: `npm run test --workspace=@hh/hh-search-svc`
3. Docker compose validates: `docker compose -f docker-compose.local.yml config`
4. 13-VERIFICATION.md documents all 5 requirements with evidence
5. All success criteria from ROADMAP.md are met
</verification>

<success_criteria>
- Test coverage for hh-trajectory-svc:
  - Predict route tests (6+ tests)
  - TrajectoryPredictor tests (6+ tests)
  - ShadowMode tests (8+ tests)
- Test coverage for ML client:
  - Circuit breaker tests (6+ tests)
- All tests pass
- 13-VERIFICATION.md confirms:
  - TRAJ-05: Next role prediction
  - TRAJ-06: Tenure prediction
  - TRAJ-07: Confidence indicators
  - TRAJ-08: Shadow mode
  - TRAJ-09: Hireability prediction
- Docker compose includes hh-trajectory-svc service
</success_criteria>

<output>
After completion, create `.planning/phases/13-ml-trajectory-prediction/13-07-SUMMARY.md`
</output>
