---
phase: 13-ml-trajectory-prediction
plan: 05
type: execute
wave: 3
depends_on: ["13-03", "13-04"]
files_modified:
  - services/hh-search-svc/src/ml-trajectory-client.ts
  - services/hh-search-svc/src/scoring.ts
  - services/hh-search-svc/src/search-service.ts
  - services/hh-search-svc/src/types.ts
autonomous: true

must_haves:
  truths:
    - "SearchService calls hh-trajectory-svc for ML predictions"
    - "ML predictions are included in search results"
    - "Shadow mode runs in background without affecting response"
    - "Fallback to rule-based scoring if hh-trajectory-svc unavailable"
  artifacts:
    - path: "services/hh-search-svc/src/ml-trajectory-client.ts"
      provides: "HTTP client for hh-trajectory-svc"
      exports: ["MLTrajectoryClient"]
    - path: "services/hh-search-svc/src/types.ts"
      provides: "Extended types with ML predictions"
      contains: "MLTrajectoryPrediction"
  key_links:
    - from: "services/hh-search-svc/src/search-service.ts"
      to: "services/hh-search-svc/src/ml-trajectory-client.ts"
      via: "import"
      pattern: "MLTrajectoryClient"
    - from: "services/hh-search-svc/src/scoring.ts"
      to: "services/hh-search-svc/src/ml-trajectory-client.ts"
      via: "optional integration"
      pattern: "mlTrajectory"
---

<objective>
Integrate hh-trajectory-svc with hh-search-svc for search result enrichment

Purpose: Wire hh-search-svc to call hh-trajectory-svc for ML-based trajectory predictions. During shadow mode, both ML and rule-based predictions are computed, but only rule-based affects scoring. ML predictions are returned in results for UI display.

Output: Search results include ML trajectory predictions (next role, tenure, hireability) alongside existing rule-based signals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ml-trajectory-prediction/13-RESEARCH.md
@.planning/phases/13-ml-trajectory-prediction/13-03-SUMMARY.md
@.planning/phases/13-ml-trajectory-prediction/13-04-SUMMARY.md
@services/hh-search-svc/src/scoring.ts
@services/hh-search-svc/src/search-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ML trajectory HTTP client</name>
  <files>
    services/hh-search-svc/src/ml-trajectory-client.ts
    services/hh-search-svc/src/config.ts
  </files>
  <action>
Create HTTP client for hh-trajectory-svc:

1. Create `services/hh-search-svc/src/ml-trajectory-client.ts`:
   - Interface `MLTrajectoryPrediction`:
     - nextRole: string
     - nextRoleConfidence: number
     - tenureMonths: { min: number; max: number }
     - hireability: number
     - lowConfidence: boolean
     - uncertaintyReason?: string

   - Interface `MLTrajectoryRequest`:
     - candidateId: string
     - titleSequence: string[]
     - tenureDurations?: number[]

   - Class `MLTrajectoryClient`:
     - Private `baseUrl: string`
     - Private `timeout: number` (default 100ms - must not impact overall latency)
     - Private `enabled: boolean`
     - Private `circuitBreaker: { failures: number; lastFailure: Date | null; open: boolean }`
     - Constructor(config: { baseUrl: string; timeout?: number; enabled?: boolean })
     - Async method `predict(request: MLTrajectoryRequest): Promise<MLTrajectoryPrediction | null>`:
       - If circuit breaker open, return null immediately
       - Make POST request to /predict with timeout
       - On success: reset circuit breaker, return prediction
       - On error: increment failures, open breaker if failures > 3, return null
       - Log errors but don't throw (graceful degradation)
     - Method `isAvailable(): boolean`:
       - Return enabled && !circuitBreaker.open
     - Async method `healthCheck(): Promise<boolean>`:
       - Call /health endpoint
       - Return true if 200, false otherwise
     - Private method `resetCircuitBreaker()`:
       - After 30 seconds, close breaker and reset failures

   - Create singleton instance with config from environment
   - Export MLTrajectoryClient class and singleton instance

2. Update `services/hh-search-svc/src/config.ts`:
   - Add `mlTrajectory` section:
     - url: string (default 'http://localhost:7109')
     - enabled: boolean (default true)
     - timeout: number (default 100)
   - Load from environment: ML_TRAJECTORY_URL, ML_TRAJECTORY_ENABLED, ML_TRAJECTORY_TIMEOUT
  </action>
  <verify>
    - `npx tsc --noEmit -p services/hh-search-svc/tsconfig.json`
    - Check client: `grep -n "circuitBreaker" services/hh-search-svc/src/ml-trajectory-client.ts`
  </verify>
  <done>ML trajectory client with circuit breaker prevents cascade failures</done>
</task>

<task type="auto">
  <name>Task 2: Extend types and integrate with scoring</name>
  <files>
    services/hh-search-svc/src/types.ts
    services/hh-search-svc/src/scoring.ts
  </files>
  <action>
Extend search types and optionally integrate ML predictions:

1. Update `services/hh-search-svc/src/types.ts`:
   - Add `MLTrajectoryPrediction` interface (or import from ml-trajectory-client)
   - Extend `ScoredCandidate` interface:
     - Add optional `mlTrajectory?: MLTrajectoryPrediction`
   - Extend `SearchResult` interface if needed:
     - Ensure mlTrajectory flows through to final response
   - Add `TrajectoryConfig` interface:
     - useMLScoring: boolean (default false during shadow mode)
     - includeMLPredictions: boolean (default true)

2. Update `services/hh-search-svc/src/scoring.ts`:
   - Import MLTrajectoryClient
   - Modify `computeSignals` or scoring function:
     - During shadow mode (useMLScoring=false):
       - Continue using rule-based trajectoryFit score
       - Attach mlTrajectory prediction to candidate for UI display
     - When useMLScoring=true (future, post-shadow):
       - Use hireability as trajectoryFit signal
       - Apply confidence weighting
   - Add helper function `attachMLPrediction(candidate, mlPrediction)`:
     - Attach prediction to candidate.mlTrajectory
   - Keep rule-based scoring as primary during shadow mode
   - Log when ML and rule-based disagree significantly (for monitoring)
  </action>
  <verify>
    - `npx tsc --noEmit -p services/hh-search-svc/tsconfig.json`
    - Check types: `grep -n "mlTrajectory" services/hh-search-svc/src/types.ts`
    - Check scoring: `grep -n "mlTrajectory" services/hh-search-svc/src/scoring.ts`
  </verify>
  <done>Types extended with ML predictions, scoring integrates predictions (shadow mode)</done>
</task>

<task type="auto">
  <name>Task 3: Wire ML predictions into search flow</name>
  <files>
    services/hh-search-svc/src/search-service.ts
    services/hh-search-svc/src/index.ts
  </files>
  <action>
Integrate ML trajectory predictions into search pipeline:

1. Update `services/hh-search-svc/src/search-service.ts`:
   - Import MLTrajectoryClient
   - In search method, after retrieving candidates:
     - Extract title sequences from candidate work history
     - If ML trajectory enabled and client available:
       - Batch predictions for top N candidates (e.g., top 50)
       - Use Promise.allSettled for resilience (don't fail if some predictions fail)
       - Attach predictions to candidates
     - Fire-and-forget: don't wait if timeout, continue with rule-based
   - Ensure ML prediction calls happen in parallel with other processing
   - Add timing metrics for ML prediction latency

2. Update `services/hh-search-svc/src/index.ts`:
   - Initialize MLTrajectoryClient on startup
   - Health check hh-trajectory-svc periodically (every 30s)
   - Report ML trajectory availability in /health response
   - Graceful degradation: log warning if hh-trajectory-svc unavailable

3. Ensure shadow mode behavior:
   - ML predictions are RETURNED in search results (for UI)
   - ML predictions do NOT affect scoring (rule-based dominates)
   - This allows safe A/B comparison in production

Handle errors gracefully:
- Timeout: return null prediction, log warning
- Connection refused: open circuit breaker, continue with rule-based
- Invalid response: log error, return null prediction
  </action>
  <verify>
    - `npm run build --workspace=@hh/hh-search-svc`
    - `npm run typecheck --workspace=@hh/hh-search-svc`
    - Check integration: `grep -n "MLTrajectoryClient" services/hh-search-svc/src/search-service.ts`
    - Check health: `grep -n "mlTrajectory" services/hh-search-svc/src/index.ts`
  </verify>
  <done>Search results include ML trajectory predictions with graceful fallback</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck --workspace=@hh/hh-search-svc`
2. Service builds: `npm run build --workspace=@hh/hh-search-svc`
3. ML client has circuit breaker (grep for circuitBreaker)
4. Types include mlTrajectory field
5. Search service calls MLTrajectoryClient
6. Graceful degradation works (search succeeds if hh-trajectory-svc down)
7. ML predictions included in response but don't affect scoring (shadow mode)
</verification>

<success_criteria>
- MLTrajectoryClient handles timeouts and failures gracefully
- Circuit breaker prevents cascade failures
- Search results include mlTrajectory field with:
  - nextRole and confidence
  - tenure prediction (min/max months)
  - hireability score
  - lowConfidence indicator
  - uncertaintyReason when applicable
- Rule-based trajectoryFit score still drives ranking (shadow mode)
- Search works even if hh-trajectory-svc is unavailable
- Health endpoint reports ML trajectory availability
</success_criteria>

<output>
After completion, create `.planning/phases/13-ml-trajectory-prediction/13-05-SUMMARY.md`
</output>
