---
phase: 13-ml-trajectory-prediction
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - services/hh-trajectory-svc/src/shadow/shadow-mode.ts
  - services/hh-trajectory-svc/src/shadow/comparison-logger.ts
  - services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts
  - services/hh-trajectory-svc/src/shadow/index.ts
  - services/hh-trajectory-svc/src/routes/shadow-stats.ts
autonomous: true

must_haves:
  truths:
    - "Shadow mode logs ML predictions alongside rule-based predictions"
    - "Comparison metrics track direction, velocity, and type agreement"
    - "Shadow logs batch-write to BigQuery or PostgreSQL"
    - "Stats endpoint returns agreement percentages"
  artifacts:
    - path: "services/hh-trajectory-svc/src/shadow/shadow-mode.ts"
      provides: "Shadow mode orchestration"
      exports: ["ShadowMode"]
    - path: "services/hh-trajectory-svc/src/shadow/comparison-logger.ts"
      provides: "Side-by-side comparison logging"
      contains: "ShadowComparison"
    - path: "services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts"
      provides: "Bridge to existing trajectory calculators"
      contains: "computeTrajectoryMetrics"
  key_links:
    - from: "services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts"
      to: "services/hh-search-svc/src/trajectory-calculators.ts"
      via: "import or HTTP call"
      pattern: "computeTrajectoryMetrics|trajectory-calculators"
---

<objective>
Implement shadow mode infrastructure for ML vs rule-based comparison logging

Purpose: Enable side-by-side logging of ML predictions and rule-based outputs during the 4-6 week validation period. This is critical for safe ML transition per RESEARCH.md - must achieve >85% direction agreement and >80% velocity agreement before promotion.

Output: Shadow mode logging that tracks ML/rule-based agreement metrics for validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ml-trajectory-prediction/13-RESEARCH.md
@.planning/phases/13-ml-trajectory-prediction/13-01-SUMMARY.md
@services/hh-search-svc/src/trajectory-calculators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rule-based bridge and comparison types</name>
  <files>
    services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts
    services/hh-trajectory-svc/src/shadow/index.ts
  </files>
  <action>
Create bridge to existing rule-based trajectory calculators:

1. Create `services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts`:
   - Interface `RuleBasedMetrics`:
     - direction: 'upward' | 'lateral' | 'downward'
     - velocity: 'fast' | 'normal' | 'slow'
     - type: 'technical_growth' | 'leadership_track' | 'lateral_move' | 'career_pivot'
     - fit: number (0-1)
   - Class `RuleBasedBridge`:
     - Copy the core trajectory calculation logic from hh-search-svc/src/trajectory-calculators.ts:
       - mapTitleToLevel function
       - calculateTrajectoryDirection function
       - calculateTrajectoryVelocity function (simplified without Together AI fallback)
       - classifyTrajectoryType function
     - Method `compute(titleSequence: string[], experiences?: ExperienceEntry[]): RuleBasedMetrics`:
       - Call all three functions
       - Return combined metrics object
     - This approach avoids inter-service HTTP calls during shadow logging
     - Document: "Duplicated from hh-search-svc - keep in sync"
   - Export default RuleBasedBridge class

2. Create `services/hh-trajectory-svc/src/shadow/index.ts`:
   - Export all shadow modules
   - Barrel export for clean imports
  </action>
  <verify>
    - `npx tsc --noEmit -p services/hh-trajectory-svc/tsconfig.json`
    - Check bridge: `grep -n "mapTitleToLevel" services/hh-trajectory-svc/src/shadow/rule-based-bridge.ts`
  </verify>
  <done>Rule-based bridge computes trajectory metrics using Phase 8 logic</done>
</task>

<task type="auto">
  <name>Task 2: Create comparison logger with batch writing</name>
  <files>
    services/hh-trajectory-svc/src/shadow/comparison-logger.ts
  </files>
  <action>
Create structured comparison logging:

1. Create `services/hh-trajectory-svc/src/shadow/comparison-logger.ts`:
   - Interface `ShadowComparison`:
     - candidateId: string
     - timestamp: Date
     - agreement: { directionMatch: boolean; velocityMatch: boolean; typeMatch: boolean }
     - ruleBased: RuleBasedMetrics
     - mlBased: { nextRole: string; confidence: number; tenureMonths: { min: number; max: number }; hireability: number }
     - inputFeatures: { titleSequence: string[]; tenureDurations?: number[] }

   - Class `ComparisonLogger`:
     - Private `logs: ShadowComparison[]`
     - Private `batchSize: number` (default 100)
     - Private `flushInterval: NodeJS.Timer | null`
     - Constructor(config: { batchSize?: number; flushIntervalMs?: number; storageType: 'postgres' | 'bigquery' | 'memory' })
     - Method `log(comparison: ShadowComparison)`:
       - Push to logs array
       - If logs.length >= batchSize, trigger flush
     - Async method `flush()`:
       - If storageType === 'postgres':
         - Batch INSERT to shadow_predictions table
         - Clear logs array
       - If storageType === 'bigquery':
         - Use BigQuery streaming insert
         - Clear logs array
       - If storageType === 'memory':
         - Keep in memory (for testing)
     - Method `getStats()`:
       - Calculate agreement percentages from in-memory logs:
         - directionAgreement: count(directionMatch) / total
         - velocityAgreement: count(velocityMatch) / total
         - typeAgreement: count(typeMatch) / total
         - totalComparisons: logs.length
     - Method `startAutoFlush(intervalMs: number)`:
       - Set interval to call flush()
     - Method `stopAutoFlush()`:
       - Clear interval
     - Method `dispose()`:
       - Flush remaining logs
       - Stop auto flush
   - Export default ComparisonLogger class
  </action>
  <verify>
    - `npx tsc --noEmit -p services/hh-trajectory-svc/tsconfig.json`
    - Check logger: `grep -n "batchSize" services/hh-trajectory-svc/src/shadow/comparison-logger.ts`
    - Check stats: `grep -n "getStats" services/hh-trajectory-svc/src/shadow/comparison-logger.ts`
  </verify>
  <done>ComparisonLogger batches shadow comparisons with auto-flush</done>
</task>

<task type="auto">
  <name>Task 3: Create shadow mode orchestrator and stats endpoint</name>
  <files>
    services/hh-trajectory-svc/src/shadow/shadow-mode.ts
    services/hh-trajectory-svc/src/routes/shadow-stats.ts
    services/hh-trajectory-svc/src/index.ts
  </files>
  <action>
Create shadow mode orchestration and monitoring:

1. Create `services/hh-trajectory-svc/src/shadow/shadow-mode.ts`:
   - Class `ShadowMode`:
     - Private `bridge: RuleBasedBridge`
     - Private `logger: ComparisonLogger`
     - Private `enabled: boolean`
     - Constructor(config: ShadowModeConfig)
     - Method `isEnabled(): boolean`
     - Async method `compare(request: PredictRequest, mlPrediction: TrajectoryPrediction): Promise<void>`:
       - If not enabled, return early
       - Compute rule-based metrics via bridge
       - Infer direction from ML prediction:
         - hireability > 0.7 -> 'upward'
         - hireability > 0.4 -> 'lateral'
         - else -> 'downward'
       - Infer velocity from tenure:
         - avg tenure < 24 months -> 'fast'
         - avg tenure > 48 months -> 'slow'
         - else -> 'normal'
       - Infer type from next role (using keyword matching)
       - Create ShadowComparison object with agreements
       - Log via ComparisonLogger
     - Method `getStats()`:
       - Return logger.getStats()
     - Method `dispose()`:
       - Dispose logger
   - Export default ShadowMode class

2. Create `services/hh-trajectory-svc/src/routes/shadow-stats.ts`:
   - Export async function `shadowStatsRoutes(fastify, shadowMode: ShadowMode)`
   - Register GET `/shadow/stats`:
     - Return current agreement statistics
     - Include:
       - directionAgreement (target: >85%)
       - velocityAgreement (target: >80%)
       - typeAgreement
       - totalComparisons
       - promotionReady: boolean (all targets met AND totalComparisons > 1000)
   - Register GET `/shadow/recent`:
     - Return last 10 comparisons for debugging

3. Update `services/hh-trajectory-svc/src/index.ts`:
   - Initialize ShadowMode after server starts
   - Pass ShadowMode to predict route
   - Register shadow-stats routes
   - Start auto-flush with 60-second interval
   - Dispose shadow mode on shutdown
  </action>
  <verify>
    - `npm run build --workspace=@hh/hh-trajectory-svc`
    - `npm run typecheck --workspace=@hh/hh-trajectory-svc`
    - Check shadow mode: `grep -n "compare" services/hh-trajectory-svc/src/shadow/shadow-mode.ts`
    - Check stats route: `grep -n "promotionReady" services/hh-trajectory-svc/src/routes/shadow-stats.ts`
  </verify>
  <done>Shadow mode compares ML vs rule-based predictions and exposes stats endpoint</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck --workspace=@hh/hh-trajectory-svc`
2. Service builds: `npm run build --workspace=@hh/hh-trajectory-svc`
3. Rule-based bridge contains trajectory calculation logic
4. ComparisonLogger batches writes (grep for batchSize)
5. ShadowMode compares ML and rule-based predictions
6. Stats endpoint returns agreement percentages
7. Promotion criteria documented (>85% direction, >80% velocity, >1000 comparisons)
</verification>

<success_criteria>
- RuleBasedBridge duplicates Phase 8 trajectory logic for local computation
- ComparisonLogger batches shadow comparisons with configurable batch size
- ShadowMode orchestrates comparison and logs results
- GET /shadow/stats returns:
  - directionAgreement percentage
  - velocityAgreement percentage
  - typeAgreement percentage
  - totalComparisons count
  - promotionReady boolean
- Auto-flush runs every 60 seconds
- Graceful shutdown disposes all resources
</success_criteria>

<output>
After completion, create `.planning/phases/13-ml-trajectory-prediction/13-04-SUMMARY.md`
</output>
