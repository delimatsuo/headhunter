---
phase: 13-ml-trajectory-prediction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/hh-trajectory-svc/package.json
  - services/hh-trajectory-svc/tsconfig.json
  - services/hh-trajectory-svc/Dockerfile
  - services/hh-trajectory-svc/src/index.ts
  - services/hh-trajectory-svc/src/config.ts
  - services/hh-trajectory-svc/src/types.ts
  - services/hh-trajectory-svc/src/routes/health.ts
  - services/hh-trajectory-svc/src/routes/predict.ts
  - services/package.json
autonomous: true

must_haves:
  truths:
    - "hh-trajectory-svc starts on port 7109 without errors"
    - "Health endpoint returns 200 OK"
    - "Predict endpoint accepts career sequence and returns trajectory prediction"
  artifacts:
    - path: "services/hh-trajectory-svc/package.json"
      provides: "Service package configuration with onnxruntime-node dependency"
      contains: "onnxruntime-node"
    - path: "services/hh-trajectory-svc/src/index.ts"
      provides: "Fastify server entrypoint"
      exports: ["start"]
    - path: "services/hh-trajectory-svc/src/config.ts"
      provides: "Environment configuration"
      exports: ["config"]
    - path: "services/hh-trajectory-svc/src/types.ts"
      provides: "TypeScript interfaces for trajectory prediction"
      contains: "TrajectoryPrediction"
  key_links:
    - from: "services/hh-trajectory-svc/src/index.ts"
      to: "services/hh-trajectory-svc/src/routes/predict.ts"
      via: "Fastify route registration"
      pattern: "fastify\\.register.*predict"
---

<objective>
Create hh-trajectory-svc Fastify service scaffolding with health and predict endpoints

Purpose: Establish the new service structure for ML-based trajectory prediction, following existing service patterns from hh-search-svc and hh-rerank-svc.

Output: Working Fastify service on port 7109 with basic route structure ready for ONNX inference integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ml-trajectory-prediction/13-RESEARCH.md
@services/hh-search-svc/package.json
@services/hh-search-svc/src/index.ts
@services/hh-rerank-svc/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service package.json and TypeScript config</name>
  <files>
    services/hh-trajectory-svc/package.json
    services/hh-trajectory-svc/tsconfig.json
    services/package.json
  </files>
  <action>
Create new hh-trajectory-svc service following existing patterns from hh-search-svc:

1. Create `services/hh-trajectory-svc/package.json`:
   - Name: `@hh/hh-trajectory-svc`
   - Dependencies: `fastify`, `@fastify/under-pressure`, `onnxruntime-node@^1.22.0`, `ioredis`, `dotenv`
   - DevDependencies: `@types/node`, `typescript`, `vitest`
   - Scripts: `build`, `dev`, `start`, `test`, `typecheck`, `lint`
   - Reference `@hh/common` as `file:../common`

2. Create `services/hh-trajectory-svc/tsconfig.json`:
   - Extend `../tsconfig.base.json`
   - Include `src/**/*.ts`
   - OutDir: `dist`
   - RootDir: `src`

3. Update workspace `services/package.json`:
   - Add `hh-trajectory-svc` to workspaces array

Use onnxruntime-node ^1.22.0 per RESEARCH.md (not jsonwebtoken - wrong domain).
  </action>
  <verify>
    - `cat services/hh-trajectory-svc/package.json | grep onnxruntime-node`
    - `cat services/package.json | grep hh-trajectory-svc`
  </verify>
  <done>Service package.json exists with onnxruntime-node dependency, workspace updated</done>
</task>

<task type="auto">
  <name>Task 2: Create config, types, and Fastify server entrypoint</name>
  <files>
    services/hh-trajectory-svc/src/config.ts
    services/hh-trajectory-svc/src/types.ts
    services/hh-trajectory-svc/src/index.ts
  </files>
  <action>
Create core service files:

1. Create `services/hh-trajectory-svc/src/config.ts`:
   - Export `config` object with:
     - `port`: number (default 7109)
     - `modelPath`: string (path to trajectory-lstm.onnx)
     - `shadowModeEnabled`: boolean (default true)
     - `redisUrl`: string (for shadow logging)
     - `confidenceThreshold`: number (default 0.6 per RESEARCH.md)
   - Load from environment variables with sensible defaults

2. Create `services/hh-trajectory-svc/src/types.ts`:
   - `TrajectoryPrediction` interface:
     - `nextRole: string`
     - `nextRoleConfidence: number`
     - `tenureMonths: { min: number; max: number }`
     - `hireability: number`
     - `lowConfidence: boolean`
     - `uncertaintyReason?: string`
   - `PredictRequest` interface:
     - `candidateId: string`
     - `titleSequence: string[]`
     - `tenureDurations?: number[]`
   - `PredictResponse` interface wrapping TrajectoryPrediction
   - `ShadowLog` interface for shadow mode logging

3. Create `services/hh-trajectory-svc/src/index.ts`:
   - Create Fastify instance with logger enabled
   - Register `@fastify/under-pressure` for load shedding
   - Register routes from `./routes/health` and `./routes/predict`
   - Start server on config.port (7109)
   - Handle graceful shutdown
   - Follow lazy initialization pattern from hh-search-svc (init model in background)
  </action>
  <verify>
    - `npx tsc --noEmit -p services/hh-trajectory-svc/tsconfig.json` (should pass or show import errors for not-yet-created files)
  </verify>
  <done>Config, types, and server entrypoint created with proper TypeScript definitions</done>
</task>

<task type="auto">
  <name>Task 3: Create health and predict route handlers</name>
  <files>
    services/hh-trajectory-svc/src/routes/health.ts
    services/hh-trajectory-svc/src/routes/predict.ts
    services/hh-trajectory-svc/Dockerfile
  </files>
  <action>
Create route handlers and Dockerfile:

1. Create `services/hh-trajectory-svc/src/routes/health.ts`:
   - Export async function `healthRoutes(fastify)`
   - Register GET `/health` returning `{ status: 'ok', service: 'hh-trajectory-svc', modelLoaded: boolean }`
   - Register GET `/ready` for Kubernetes readiness probe (checks model loaded)

2. Create `services/hh-trajectory-svc/src/routes/predict.ts`:
   - Export async function `predictRoutes(fastify)`
   - Register POST `/predict` accepting PredictRequest body
   - For now, return stub response with placeholder values (actual inference in Plan 02)
   - Include JSON schema validation for request body
   - Add response schema for type safety

3. Create `services/hh-trajectory-svc/Dockerfile`:
   - Multi-stage build: builder + runtime
   - Use `node:20-slim` base image
   - Copy package.json, install dependencies, copy dist
   - Expose port 7109
   - CMD: `["node", "dist/index.js"]`
   - Follow pattern from existing service Dockerfiles
  </action>
  <verify>
    - `cd services && npm install --workspace=@hh/hh-trajectory-svc`
    - `npm run build --workspace=@hh/hh-trajectory-svc`
    - `npm run dev --workspace=@hh/hh-trajectory-svc &` (start in background)
    - `curl http://localhost:7109/health` (should return 200)
    - `curl -X POST http://localhost:7109/predict -H "Content-Type: application/json" -d '{"candidateId":"test","titleSequence":["Engineer"]}'` (should return stub response)
    - Kill background process
  </verify>
  <done>Service starts on port 7109, health endpoint returns 200, predict endpoint accepts requests</done>
</task>

</tasks>

<verification>
1. Service structure exists at `services/hh-trajectory-svc/`
2. TypeScript compiles without errors: `npm run typecheck --workspace=@hh/hh-trajectory-svc`
3. Service starts: `npm run dev --workspace=@hh/hh-trajectory-svc`
4. Health endpoint works: `curl localhost:7109/health`
5. Predict endpoint accepts requests: `curl -X POST localhost:7109/predict -H "Content-Type: application/json" -d '{"candidateId":"test","titleSequence":["Engineer"]}'`
</verification>

<success_criteria>
- hh-trajectory-svc exists as new service in services/ directory
- Package.json includes onnxruntime-node@^1.22.0 dependency
- Service starts on port 7109 without errors
- GET /health returns 200 with service info
- POST /predict accepts PredictRequest and returns TrajectoryPrediction (stub)
- TypeScript compiles cleanly
- Workspace package.json includes new service
</success_criteria>

<output>
After completion, create `.planning/phases/13-ml-trajectory-prediction/13-01-SUMMARY.md`
</output>
