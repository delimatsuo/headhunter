---
phase: 04-multi-signal-scoring-framework
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - services/hh-search-svc/src/index.ts
  - services/hh-search-svc/src/routes/search.ts
autonomous: true

must_haves:
  truths:
    - "API route accepts signalWeights and roleType in request body"
    - "Request validation allows partial SignalWeightConfig"
    - "Search endpoint passes weight overrides to SearchService"
    - "Module exports include signal-weights and scoring modules"
  artifacts:
    - path: "services/hh-search-svc/src/routes/search.ts"
      provides: "API route with signal weight parameters"
      contains: "signalWeights"
    - path: "services/hh-search-svc/src/index.ts"
      provides: "Module re-exports for external consumers"
      contains: "signal-weights"
  key_links:
    - from: "services/hh-search-svc/src/routes/search.ts"
      to: "services/hh-search-svc/src/search-service.ts"
      via: "Request transformation"
      pattern: "signalWeights.*roleType"
---

<objective>
Wire signal weight parameters through the API layer and ensure module exports.

Purpose: Enable API consumers to pass custom signal weights and role types. Ensure all new modules are properly exported for external use.

Output:
- Updated search route accepting signalWeights and roleType
- Updated index.ts with module exports
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-signal-scoring-framework/04-RESEARCH.md
@.planning/phases/04-multi-signal-scoring-framework/04-01-SUMMARY.md
@.planning/phases/04-multi-signal-scoring-framework/04-02-SUMMARY.md

# Reference files
@services/hh-search-svc/src/index.ts
@services/hh-search-svc/src/routes/search.ts
@services/hh-search-svc/src/types.ts
@services/hh-search-svc/src/signal-weights.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update search route to accept signal weight parameters</name>
  <files>services/hh-search-svc/src/routes/search.ts</files>
  <action>
Update the search route to accept and validate signal weight parameters.

1. **Check existing route structure** - Read the file to understand the current pattern for request validation

2. **Add signalWeights and roleType to request schema** - If using Fastify schema validation:
   ```typescript
   // Add to request body schema properties
   signalWeights: {
     type: 'object',
     additionalProperties: true,
     properties: {
       vectorSimilarity: { type: 'number', minimum: 0, maximum: 1 },
       levelMatch: { type: 'number', minimum: 0, maximum: 1 },
       specialtyMatch: { type: 'number', minimum: 0, maximum: 1 },
       techStackMatch: { type: 'number', minimum: 0, maximum: 1 },
       functionMatch: { type: 'number', minimum: 0, maximum: 1 },
       trajectoryFit: { type: 'number', minimum: 0, maximum: 1 },
       companyPedigree: { type: 'number', minimum: 0, maximum: 1 },
       skillsMatch: { type: 'number', minimum: 0, maximum: 1 }
     }
   },
   roleType: {
     type: 'string',
     enum: ['executive', 'manager', 'ic', 'default']
   }
   ```

3. **Pass parameters to SearchService** - In the route handler:
   ```typescript
   const request: HybridSearchRequest = {
     query: body.query,
     embedding: body.embedding,
     jdHash: body.jdHash,
     jobDescription: body.jobDescription,
     filters: body.filters,
     limit: body.limit,
     offset: body.offset,
     includeDebug: body.includeDebug,
     // NEW: Signal weight parameters
     signalWeights: body.signalWeights,
     roleType: body.roleType
   };
   ```

4. **Import RoleType if needed** for type safety:
   ```typescript
   import type { RoleType } from '../signal-weights';
   ```
  </action>
  <verify>
- `npm run typecheck --prefix services/hh-search-svc` passes
- `grep "signalWeights" services/hh-search-svc/src/routes/search.ts` shows parameter handling
- `grep "roleType" services/hh-search-svc/src/routes/search.ts` shows enum validation
  </verify>
  <done>
- Search route schema accepts signalWeights object with 0-1 number fields
- Search route schema accepts roleType enum with 4 valid values
- Route handler passes signalWeights and roleType to HybridSearchRequest
  </done>
</task>

<task type="auto">
  <name>Task 2: Add module exports to index.ts</name>
  <files>services/hh-search-svc/src/index.ts</files>
  <action>
Ensure all new modules are exported from the service's main entry point.

1. **Read existing index.ts** to understand export pattern

2. **Add exports for signal-weights module**:
   ```typescript
   export {
     SignalWeightConfig,
     RoleType,
     ROLE_WEIGHT_PRESETS,
     resolveWeights,
     normalizeWeights
   } from './signal-weights';
   ```

3. **Add exports for scoring module**:
   ```typescript
   export {
     computeWeightedScore,
     extractSignalScores,
     normalizeVectorScore
   } from './scoring';
   ```

4. **Ensure SignalScores is exported** from types:
   ```typescript
   export type { SignalScores } from './types';
   // or add to existing types export if present
   ```

5. **Verify export order** - Types first, then constants, then functions
  </action>
  <verify>
- `npm run typecheck --prefix services/hh-search-svc` passes
- `grep "signal-weights" services/hh-search-svc/src/index.ts` shows export
- `grep "scoring" services/hh-search-svc/src/index.ts` shows export
  </verify>
  <done>
- signal-weights module exports are re-exported from index.ts
- scoring module exports are re-exported from index.ts
- SignalScores type is exported from index.ts
- All exports compile without circular dependency issues
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run typecheck --prefix services/hh-search-svc`
2. Build service: `npm run build --prefix services/hh-search-svc`
3. Test import from package: Verify exports are accessible
4. Manual API test: POST to /search with signalWeights and roleType in body
</verification>

<success_criteria>
- API accepts signalWeights object in request body
- API accepts roleType enum in request body
- Schema validates weight values are between 0 and 1
- Schema validates roleType is one of the 4 valid values
- All new modules are exported from index.ts for external consumers
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-signal-scoring-framework/04-04-SUMMARY.md`
</output>
