---
phase: 03-hybrid-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/hh-search-svc/src/pgvector-client.ts
autonomous: true

must_haves:
  truths:
    - "Text search (FTS) contributes non-zero scores when query contains matching terms"
    - "Candidates with exact keyword matches have textScore > 0"
    - "FTS query parameters are logged for debugging"
  artifacts:
    - path: "services/hh-search-svc/src/pgvector-client.ts"
      provides: "FTS debugging and fix"
      contains: "FTS debug logging"
  key_links:
    - from: "hybridSearch function"
      to: "text_candidates CTE"
      via: "proper textQuery passing and FTS match"
      pattern: "plainto_tsquery.*textQuery"
---

<objective>
Fix the textScore=0 issue where full-text search (FTS) is not contributing to hybrid search results.

Purpose: Currently textScore is always 0 for all candidates, meaning hybrid search is effectively vector-only. This defeats the purpose of hybrid search (finding exact keyword matches like "AWS Solutions Architect").

Output: Text search contributes non-zero scores when query terms match search_document content. FTS debug logging added for validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hybrid-search/03-RESEARCH.md

# Key source files
@services/hh-search-svc/src/pgvector-client.ts
@services/hh-search-svc/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FTS diagnostic logging</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Add diagnostic logging to the hybridSearch function to understand why textScore is always 0.

Before executing the main hybrid query, add a diagnostic query that:
1. Logs the textQuery value being passed
2. Tests if plainto_tsquery produces a valid tsquery for the given textQuery
3. Counts how many candidates match the FTS query
4. Logs the search_document population status

Add logging at the start of hybridSearch (after parameter validation):
```typescript
this.logger.info({
  textQuery: query.textQuery,
  textQueryEmpty: !query.textQuery || query.textQuery.trim() === '',
  limit: query.limit
}, 'FTS debug: query parameters');
```

Add a diagnostic query to check FTS match potential:
```typescript
if (query.textQuery && query.textQuery.trim()) {
  const ftsCheckSql = `
    SELECT
      COUNT(*) as total_candidates,
      COUNT(CASE WHEN search_document IS NOT NULL THEN 1 END) as has_fts,
      COUNT(CASE WHEN search_document @@ plainto_tsquery('${PG_FTS_DICTIONARY}', $2) THEN 1 END) as matches_query,
      plainto_tsquery('${PG_FTS_DICTIONARY}', $2)::text as parsed_query
    FROM ${this.config.schema}.${this.config.profilesTable}
    WHERE tenant_id = $1
  `;
  const ftsCheck = await client.query(ftsCheckSql, [query.tenantId, query.textQuery]);
  this.logger.info({
    ftsCheck: ftsCheck.rows[0],
    dictionary: PG_FTS_DICTIONARY
  }, 'FTS debug: search_document analysis');
}
```

This logging will reveal whether:
- textQuery is being passed correctly (not empty/null)
- search_document is populated for candidates
- The FTS query matches any candidates
- The parsed tsquery is valid
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for logging: `grep -n "FTS debug" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
FTS diagnostic logging added to hybridSearch function. Logs textQuery parameters and FTS match analysis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix text_candidates CTE to ensure FTS contributes scores</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Analyze the current text_candidates CTE in hybridSearch and fix issues preventing textScore contribution.

Current issues identified in research:
1. The text_candidates CTE may not be joining properly with combined/scored CTEs
2. The UNION ALL approach may be losing text scores
3. The text_score calculation may be returning 0 due to how ts_rank_cd normalizes

Fix the SQL query structure:

1. Ensure text_candidates CTE includes both candidate_id and a proper text_rank:
```sql
text_candidates AS (
  SELECT
    cp.candidate_id,
    ts_rank_cd(cp.search_document, plainto_tsquery('${PG_FTS_DICTIONARY}', $4)) AS text_score,
    ROW_NUMBER() OVER (ORDER BY ts_rank_cd(cp.search_document, plainto_tsquery('${PG_FTS_DICTIONARY}', $4)) DESC) AS text_rank
  FROM ${this.config.schema}.${this.config.profilesTable} AS cp
  WHERE cp.tenant_id = $1
    AND $4 IS NOT NULL
    AND $4 != ''
    AND cp.search_document @@ plainto_tsquery('${PG_FTS_DICTIONARY}', $4)
  ORDER BY text_score DESC
  LIMIT $3
)
```

2. Ensure text_score is properly propagated through the combined CTE by using a FULL OUTER JOIN pattern instead of UNION ALL:
```sql
combined AS (
  SELECT
    COALESCE(vc.candidate_id, tc.candidate_id) AS candidate_id,
    vc.vector_score,
    vc.metadata,
    vc.updated_at,
    tc.text_score,
    tc.text_rank
  FROM vector_candidates vc
  FULL OUTER JOIN text_candidates tc ON vc.candidate_id = tc.candidate_id
)
```

3. In the scored CTE, use the text_score directly from combined:
```sql
COALESCE(c.text_score, 0) AS text_score
```

Key insight: The current UNION ALL approach duplicates candidate_ids and loses the text_score association. FULL OUTER JOIN preserves both vector and text scores for each candidate.
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Review SQL structure: `grep -A 50 "text_candidates AS" services/hh-search-svc/src/pgvector-client.ts | head -60`
  </verify>
  <done>
text_candidates CTE fixed with FULL OUTER JOIN pattern. Text scores properly propagated through query chain.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add text_rank to support RRF in next plan</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Prepare for RRF by adding rank columns (vector_rank and text_rank) to the hybrid search query.

RRF (Reciprocal Rank Fusion) requires rank positions, not raw scores. Add ranking to both CTEs:

1. In vector_candidates CTE, add:
```sql
ROW_NUMBER() OVER (ORDER BY embedding <=> $2 ASC) AS vector_rank
```

2. In text_candidates CTE (already added in Task 2):
```sql
ROW_NUMBER() OVER (ORDER BY ts_rank_cd(cp.search_document, plainto_tsquery('${PG_FTS_DICTIONARY}', $4)) DESC) AS text_rank
```

3. Propagate ranks through combined CTE:
```sql
combined AS (
  SELECT
    COALESCE(vc.candidate_id, tc.candidate_id) AS candidate_id,
    vc.vector_score,
    vc.vector_rank,
    vc.metadata,
    vc.updated_at,
    tc.text_score,
    tc.text_rank
  FROM vector_candidates vc
  FULL OUTER JOIN text_candidates tc ON vc.candidate_id = tc.candidate_id
)
```

4. Include ranks in final SELECT (for debugging/verification):
```sql
SELECT
  ...
  vector_rank,
  text_rank,
  ...
```

Note: The PgHybridSearchRow type in types.ts will need to be updated in Plan 03 to include these new fields.
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for rank columns: `grep -n "vector_rank\|text_rank" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
vector_rank and text_rank columns added to hybrid search query, ready for RRF implementation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   ```bash
   cd services/hh-search-svc && npm run build
   ```

2. FTS diagnostic logging exists:
   ```bash
   grep -c "FTS debug" services/hh-search-svc/src/pgvector-client.ts
   # Should return 2 (two logging statements)
   ```

3. text_candidates uses FULL OUTER JOIN pattern:
   ```bash
   grep -c "FULL OUTER JOIN text_candidates" services/hh-search-svc/src/pgvector-client.ts
   # Should return 1
   ```

4. Both vector_rank and text_rank are computed:
   ```bash
   grep -c "vector_rank\|text_rank" services/hh-search-svc/src/pgvector-client.ts
   # Should return multiple (in CTEs and SELECT)
   ```
</verification>

<success_criteria>
- FTS diagnostic logging added for debugging textScore=0 issue
- text_candidates CTE fixed with FULL OUTER JOIN pattern
- vector_rank and text_rank columns added for RRF preparation
- TypeScript compiles successfully
- Code ready for RRF implementation in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-search/03-01-SUMMARY.md`
</output>
