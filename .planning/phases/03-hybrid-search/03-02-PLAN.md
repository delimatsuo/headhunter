---
phase: 03-hybrid-search
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/hh-search-svc/src/config.ts
  - services/hh-search-svc/src/pgvector-client.ts
autonomous: true

must_haves:
  truths:
    - "RRF k parameter is configurable via environment variable"
    - "Per-method limit is configurable for controlling how many candidates each search method retrieves"
    - "Default values are sensible (k=60, perMethodLimit=100)"
  artifacts:
    - path: "services/hh-search-svc/src/config.ts"
      provides: "RRF configuration parameters"
      contains: "rrfK"
  key_links:
    - from: "services/hh-search-svc/src/config.ts"
      to: "SearchRuntimeConfig interface"
      via: "rrfK and perMethodLimit fields"
      pattern: "rrfK.*parseNumber"
---

<objective>
Add RRF (Reciprocal Rank Fusion) configuration parameters to the search service.

Purpose: RRF requires a tunable k parameter that controls how much top ranks are favored. Making this configurable enables A/B testing and tuning without code changes.

Output: SearchRuntimeConfig includes rrfK (default 60) and perMethodLimit (default 100) configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hybrid-search/03-RESEARCH.md

# Key source files
@services/hh-search-svc/src/config.ts
@services/hh-search-svc/src/pgvector-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RRF configuration to SearchRuntimeConfig</name>
  <files>services/hh-search-svc/src/config.ts</files>
  <action>
Add RRF-related configuration parameters to the SearchRuntimeConfig interface and getSearchServiceConfig function.

1. Update the SearchRuntimeConfig interface (around line 69):
```typescript
export interface SearchRuntimeConfig {
  vectorWeight: number;
  textWeight: number;
  minSimilarity: number;
  maxResults: number;
  ecoBoostFactor: number;
  confidenceFloor: number;
  warmupMultiplier: number;
  rerankCandidateLimit: number;
  rerankIncludeReasons: boolean;
  // RRF configuration
  rrfK: number;              // RRF k parameter, controls top-rank favoritism (default 60)
  perMethodLimit: number;    // Candidates retrieved per search method before fusion (default 100)
  enableRrf: boolean;        // Feature flag to toggle RRF vs weighted sum (default true)
}
```

2. Update the search config initialization in getSearchServiceConfig (around line 233):
```typescript
const search: SearchRuntimeConfig = {
  vectorWeight: parseNumber(process.env.SEARCH_HYBRID_VECTOR_WEIGHT, 0.65),
  textWeight: parseNumber(process.env.SEARCH_HYBRID_TEXT_WEIGHT, 0.35),
  minSimilarity: parseNumber(process.env.SEARCH_MIN_SIMILARITY, 0.25),
  maxResults: Math.max(1, parseNumber(process.env.SEARCH_MAX_RESULTS, 50)),
  ecoBoostFactor: parseNumber(process.env.SEARCH_ECO_BOOST_FACTOR, 1.2),
  confidenceFloor: parseNumber(process.env.SEARCH_CONFIDENCE_FLOOR, 0.2),
  warmupMultiplier: Math.max(1, parseNumber(process.env.SEARCH_WARMUP_MULTIPLIER, 3)),
  rerankCandidateLimit: Math.max(1, parseNumber(process.env.SEARCH_RERANK_CANDIDATE_LIMIT, 200)),
  rerankIncludeReasons: parseBoolean(process.env.SEARCH_RERANK_INCLUDE_REASONS, true),
  // RRF configuration
  rrfK: Math.max(1, parseNumber(process.env.SEARCH_RRF_K, 60)),
  perMethodLimit: Math.max(10, parseNumber(process.env.SEARCH_PER_METHOD_LIMIT, 100)),
  enableRrf: parseBoolean(process.env.SEARCH_ENABLE_RRF, true)
};
```

Why these defaults:
- rrfK=60: Standard value used in Elasticsearch, OpenSearch, research papers
- perMethodLimit=100: Sufficient candidates per method while avoiding memory issues
- enableRrf=true: New default behavior, can disable for A/B testing
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for new config: `grep -n "rrfK\|perMethodLimit\|enableRrf" services/hh-search-svc/src/config.ts`
  </verify>
  <done>
SearchRuntimeConfig updated with rrfK, perMethodLimit, and enableRrf configuration parameters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PgHybridSearchQuery to accept RRF config</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Update the PgHybridSearchQuery interface to include RRF configuration parameters.

1. Update PgHybridSearchQuery interface (around line 11):
```typescript
export interface PgHybridSearchQuery {
  tenantId: string;
  embedding: number[];
  textQuery: string;
  limit: number;
  offset: number;
  minSimilarity: number;
  vectorWeight: number;
  textWeight: number;
  warmupMultiplier: number;
  filters?: HybridSearchFilters;
  // RRF configuration
  rrfK: number;           // RRF k parameter (default 60)
  perMethodLimit: number; // Candidates per method before fusion (default 100)
  enableRrf: boolean;     // Use RRF vs weighted sum
}
```

2. Update hybridSearch to use the new parameters for the per-method limits.

Currently the code calculates vectorPrefetch based on limit and warmupMultiplier:
```typescript
const warmupMultiplier = Number.isFinite(query.warmupMultiplier)
  ? Math.max(1, query.warmupMultiplier) : 1;
const vectorPrefetch = Math.ceil(query.limit * warmupMultiplier);
const vectorLimit = Math.max(query.limit, Math.min(vectorPrefetch, query.limit + 50));
```

Replace with simpler perMethodLimit:
```typescript
const perMethodLimit = Number.isFinite(query.perMethodLimit)
  ? Math.max(10, query.perMethodLimit) : 100;
```

Use perMethodLimit for both vector_candidates LIMIT and text_candidates LIMIT.
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for new interface fields: `grep -n "rrfK\|perMethodLimit\|enableRrf" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
PgHybridSearchQuery interface updated with RRF configuration. perMethodLimit used for both CTEs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add RRF k parameter to SQL query values</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Prepare the hybridSearch SQL query to accept the RRF k parameter.

1. Add rrfK to the values array (around line 100):
```typescript
const values: unknown[] = [
  query.tenantId,       // $1
  toSql(query.embedding), // $2
  perMethodLimit,       // $3 (was vectorLimit)
  query.textQuery,      // $4
  query.vectorWeight,   // $5
  query.textWeight,     // $6
  query.minSimilarity,  // $7
  query.limit,          // $8
  query.offset,         // $9
  query.rrfK            // $10 (new - for RRF calculation)
];
```

2. Log the RRF configuration for debugging:
```typescript
this.logger.info({
  rrfK: query.rrfK,
  perMethodLimit,
  enableRrf: query.enableRrf,
  limit: query.limit
}, 'RRF config: hybrid search parameters');
```

Note: The actual RRF scoring SQL will be implemented in Plan 03. This task prepares the parameter plumbing.
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for rrfK in values: `grep -n "rrfK" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
RRF k parameter added to SQL values array and logging added for debugging.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   ```bash
   cd services/hh-search-svc && npm run build
   ```

2. Config has RRF parameters:
   ```bash
   grep -c "rrfK" services/hh-search-svc/src/config.ts
   # Should return 2+ (interface and initialization)
   ```

3. PgHybridSearchQuery has RRF parameters:
   ```bash
   grep -A 20 "interface PgHybridSearchQuery" services/hh-search-svc/src/pgvector-client.ts | grep -c "rrfK\|perMethodLimit"
   # Should return 2+
   ```

4. RRF logging exists:
   ```bash
   grep -c "RRF config" services/hh-search-svc/src/pgvector-client.ts
   # Should return 1
   ```
</verification>

<success_criteria>
- SearchRuntimeConfig includes rrfK (default 60), perMethodLimit (default 100), enableRrf (default true)
- PgHybridSearchQuery interface includes RRF configuration fields
- SQL values array includes rrfK parameter ($10)
- Logging added for RRF configuration debugging
- TypeScript compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-search/03-02-SUMMARY.md`
</output>
