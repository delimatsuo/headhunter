---
phase: 03-hybrid-search
plan: 04
type: execute
wave: 2
depends_on: [03-03]
files_modified:
  - services/hh-search-svc/src/pgvector-client.ts
autonomous: false

must_haves:
  truths:
    - "Searching for exact keywords like 'AWS Solutions Architect' returns candidates with textScore > 0"
    - "Searching for 'K8s' returns candidates with 'Kubernetes' (semantic match via vector)"
    - "Search results combine candidates from both vector AND text search"
    - "Search latency remains under 1s (no regression)"
  artifacts:
    - path: "services/hh-search-svc/src/pgvector-client.ts"
      provides: "Complete hybrid search with RRF"
      contains: "RRF hybrid search"
  key_links:
    - from: "hybridSearch"
      to: "rrf_scored CTE"
      via: "SQL execution"
      pattern: "rrf_score"
---

<objective>
Verify RRF hybrid search works end-to-end and add summary logging.

Purpose: Validate that both vector and text search contribute to results, and that RRF fusion produces the expected ranking behavior.

Output: Verified hybrid search with RRF. Summary logging shows vector/text match counts and RRF score distribution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hybrid-search/03-RESEARCH.md

# Key source files - modified by prior plans
@services/hh-search-svc/src/pgvector-client.ts
@services/hh-search-svc/src/config.ts
@services/hh-search-svc/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RRF summary logging</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Add summary logging after hybridSearch execution to validate RRF is working.

After the SQL query executes and before returning results, add comprehensive logging:

```typescript
// After: const result: QueryResult<PgHybridSearchRow> = await client.query({ text: sql, values });

// RRF result summary logging
const vectorOnlyCount = result.rows.filter(r => (r.vector_score ?? 0) > 0 && (r.text_score ?? 0) === 0).length;
const textOnlyCount = result.rows.filter(r => (r.vector_score ?? 0) === 0 && (r.text_score ?? 0) > 0).length;
const bothCount = result.rows.filter(r => (r.vector_score ?? 0) > 0 && (r.text_score ?? 0) > 0).length;
const noScoreCount = result.rows.filter(r => (r.vector_score ?? 0) === 0 && (r.text_score ?? 0) === 0).length;

const rrfScores = result.rows.map(r => r.rrf_score ?? 0).filter(s => s > 0);
const avgRrfScore = rrfScores.length > 0 ? rrfScores.reduce((a, b) => a + b, 0) / rrfScores.length : 0;
const maxRrfScore = rrfScores.length > 0 ? Math.max(...rrfScores) : 0;
const minRrfScore = rrfScores.length > 0 ? Math.min(...rrfScores) : 0;

this.logger.info({
  totalResults: result.rows.length,
  vectorOnly: vectorOnlyCount,
  textOnly: textOnlyCount,
  both: bothCount,
  noScore: noScoreCount,
  rrfStats: {
    avg: avgRrfScore.toFixed(6),
    max: maxRrfScore.toFixed(6),
    min: minRrfScore.toFixed(6)
  },
  textQuery: query.textQuery?.slice(0, 50),
  rrfK: query.rrfK,
  enableRrf: query.enableRrf
}, 'RRF hybrid search summary');
```

This logging will show:
- How many candidates came from vector-only, text-only, or both methods
- RRF score distribution (validates fusion is working)
- Whether textScore > 0 for any candidates (validates FTS fix)
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for summary logging: `grep -n "RRF hybrid search summary" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
RRF summary logging added to hybridSearch. Shows vector/text match breakdown and RRF score distribution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fallback for empty text queries</name>
  <files>services/hh-search-svc/src/pgvector-client.ts</files>
  <action>
Handle edge cases where textQuery is empty or produces no FTS matches.

When textQuery is empty/null, the text_candidates CTE returns no rows, which is correct. But ensure:

1. The FULL OUTER JOIN still returns vector-only candidates
2. RRF scoring degrades gracefully: 1/(k+vector_rank) + 0

Add explicit handling:

```typescript
// Before building SQL
const hasTextQuery = query.textQuery && query.textQuery.trim().length > 0;

this.logger.debug({
  hasTextQuery,
  textQueryLength: query.textQuery?.length ?? 0
}, 'RRF query type');
```

Also add a warning when text_candidates returns 0 rows despite having a query:

```typescript
// After getting results, check if FTS contributed
if (hasTextQuery && textOnlyCount === 0 && bothCount === 0) {
  this.logger.warn({
    textQuery: query.textQuery?.slice(0, 100),
    totalResults: result.rows.length,
    vectorOnly: vectorOnlyCount
  }, 'RRF warning: FTS returned no matches despite having a text query. Check search_document population.');
}
```

This warning helps diagnose when FTS should be matching but isn't.
  </action>
  <verify>
TypeScript compiles: `cd services/hh-search-svc && npm run build`
Grep for warning: `grep -n "FTS returned no matches" services/hh-search-svc/src/pgvector-client.ts`
  </verify>
  <done>
Edge case handling added for empty text queries. Warning logged when FTS expected but not contributing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify RRF hybrid search end-to-end</name>
  <what-built>
Complete RRF hybrid search implementation:
- FTS diagnostic logging (Plan 01)
- RRF configuration (Plan 02)
- RRF scoring SQL with FULL OUTER JOIN (Plan 03)
- Summary logging and edge case handling (Plan 04)
  </what-built>
  <how-to-verify>
1. Start the search service locally:
   ```bash
   cd services/hh-search-svc
   npm run dev
   ```

2. Test semantic search (vector match):
   ```bash
   curl -X POST http://localhost:7102/search \
     -H "Content-Type: application/json" \
     -H "X-Tenant-ID: test" \
     -d '{"query": "K8s engineer", "limit": 10, "includeDebug": true}'
   ```
   Expected: Returns candidates with "Kubernetes" (semantic match via vector)

3. Test exact keyword search (text match):
   ```bash
   curl -X POST http://localhost:7102/search \
     -H "Content-Type: application/json" \
     -H "X-Tenant-ID: test" \
     -d '{"query": "AWS Solutions Architect", "limit": 10, "includeDebug": true}'
   ```
   Expected: Some candidates have textScore > 0 (exact certification match)

4. Check logs for RRF summary:
   ```
   RRF hybrid search summary
   - totalResults: N
   - vectorOnly: X
   - textOnly: Y  (should be > 0 for exact keywords)
   - both: Z
   - rrfStats: { avg: ..., max: ..., min: ... }
   ```

5. Verify debug output includes RRF breakdown:
   ```json
   {
     "debug": {
       "rrfConfig": { "enabled": true, "k": 60, "perMethodLimit": 100 },
       "scoreBreakdown": [
         { "candidateId": "...", "vectorScore": 0.85, "textScore": 0.12, "rrfScore": 0.032 }
       ]
     }
   }
   ```

6. Confirm latency is acceptable:
   ```json
   { "timings": { "totalMs": <1000 } }
   ```
  </how-to-verify>
  <resume-signal>
Type "approved" if:
- Semantic search returns relevant results
- Exact keyword search returns candidates with textScore > 0
- RRF summary logging shows vectorOnly, textOnly, and both counts
- Latency is under 1s

Or describe issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   ```bash
   cd services/hh-search-svc && npm run build
   ```

2. RRF summary logging exists:
   ```bash
   grep "RRF hybrid search summary" services/hh-search-svc/src/pgvector-client.ts
   ```

3. FTS warning exists:
   ```bash
   grep "FTS returned no matches" services/hh-search-svc/src/pgvector-client.ts
   ```

4. Human verification confirms:
   - Semantic search works (K8s -> Kubernetes)
   - Exact keyword search works (textScore > 0)
   - RRF fusion combines both search methods
   - Latency < 1s
</verification>

<success_criteria>
- RRF summary logging shows vector/text match breakdown
- Warning logged when FTS expected but not contributing
- Human verification confirms:
  - "K8s" returns Kubernetes candidates (semantic)
  - "AWS Solutions Architect" has textScore > 0 (exact match)
  - Results combine vector AND text matches
  - Latency remains under 1s
- Phase 3 requirements met:
  - HYBD-01: Vector similarity search (working)
  - HYBD-02: BM25 text search (textScore > 0)
  - HYBD-03: RRF combines results
  - HYBD-04: Configurable k parameter
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-search/03-04-SUMMARY.md`
</output>
