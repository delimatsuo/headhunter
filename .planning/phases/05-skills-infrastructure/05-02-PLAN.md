---
phase: 05-skills-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - functions/src/vector-search.ts
autonomous: true

must_haves:
  truths:
    - "Hardcoded synonyms map removed from vector-search.ts"
    - "findMatchingSkill uses skills-service normalizeSkillName"
    - "Skill matching respects all EllaAI aliases, not just the 6 hardcoded ones"
  artifacts:
    - path: "functions/src/vector-search.ts"
      provides: "Skill matching via centralized skills service"
      contains: "from './shared/skills-service'"
  key_links:
    - from: "functions/src/vector-search.ts"
      to: "functions/src/shared/skills-service.ts"
      via: "Import normalizeSkillName for alias resolution"
      pattern: "normalizeSkillName"
---

<objective>
Refactor vector-search.ts to use centralized skills service instead of hardcoded synonyms.

Purpose: Replace the 6-entry hardcoded synonym map with the 200+ skill EllaAI taxonomy. This ensures consistent skill matching across all search paths.

Output:
- Updated `functions/src/vector-search.ts` using skills-service for alias resolution
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-skills-infrastructure/05-RESEARCH.md

# Prior plan context (skills service now exists)
@.planning/phases/05-skills-infrastructure/05-01-SUMMARY.md

# Target file
@functions/src/vector-search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import skills-service in vector-search.ts</name>
  <files>functions/src/vector-search.ts</files>
  <action>
Add import statement near the top of the file (after other imports):

```typescript
import { normalizeSkillName, skillsMatch } from './shared/skills-service';
```

This imports the O(1) skill normalization functions from the new centralized service.
  </action>
  <verify>
- `grep "from './shared/skills-service'" functions/src/vector-search.ts` shows import
  </verify>
  <done>
- skills-service import added to vector-search.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor findMatchingSkill to use skills-service</name>
  <files>functions/src/vector-search.ts</files>
  <action>
Locate the `findMatchingSkill` method (around line 1267) and refactor it:

**BEFORE** (lines 1267-1309 approximately):
```typescript
private findMatchingSkill(candidateSkills: Array<{ skill: string, confidence: number, source: string, category: string }>, targetSkill: string): { skill: string, confidence: number } | null {
  const target = targetSkill.toLowerCase();

  // Exact match first
  const exactMatch = candidateSkills.find(s => s.skill === target);
  if (exactMatch) {
    return { skill: exactMatch.skill, confidence: exactMatch.confidence };
  }

  // Partial match (skill contains target or vice versa)
  const partialMatch = candidateSkills.find(s =>
    s.skill.includes(target) || target.includes(s.skill)
  );
  if (partialMatch) {
    return {
      skill: partialMatch.skill,
      confidence: partialMatch.confidence * 0.8 // Penalty for partial match
    };
  }

  // Synonym matching (basic)
  const synonyms: Record<string, string[]> = {
    'javascript': ['js', 'ecmascript', 'node.js', 'nodejs'],
    'python': ['py', 'python3'],
    'kubernetes': ['k8s'],
    'docker': ['containerization', 'containers'],
    'aws': ['amazon web services'],
    'machine learning': ['ml', 'ai', 'artificial intelligence']
  };

  for (const [canonical, alts] of Object.entries(synonyms)) {
    if (target === canonical || alts.includes(target)) {
      const synonymMatch = candidateSkills.find(s =>
        s.skill === canonical || alts.includes(s.skill)
      );
      if (synonymMatch) {
        return { skill: synonymMatch.skill, confidence: synonymMatch.confidence };
      }
    }
  }

  return null;
}
```

**AFTER**:
```typescript
/**
 * Find matching skill with alias normalization via skills-service.
 * Uses centralized EllaAI taxonomy with 200+ skills and aliases.
 */
private findMatchingSkill(
  candidateSkills: Array<{ skill: string, confidence: number, source: string, category: string }>,
  targetSkill: string
): { skill: string, confidence: number } | null {
  // Normalize target skill to canonical form (JS -> JavaScript, K8s -> Kubernetes)
  const normalizedTarget = normalizeSkillName(targetSkill);

  // Exact match on normalized names
  const exactMatch = candidateSkills.find(s =>
    normalizeSkillName(s.skill) === normalizedTarget
  );
  if (exactMatch) {
    return { skill: exactMatch.skill, confidence: exactMatch.confidence };
  }

  // Partial match - skill name contains normalized target or vice versa
  // Only for terms of 3+ characters to avoid false positives (e.g., "C" matching "Executive")
  if (normalizedTarget.length >= 3) {
    const partialMatch = candidateSkills.find(s => {
      const normalizedCandidate = normalizeSkillName(s.skill).toLowerCase();
      const normalizedTargetLower = normalizedTarget.toLowerCase();
      return normalizedCandidate.includes(normalizedTargetLower) ||
             normalizedTargetLower.includes(normalizedCandidate);
    });

    if (partialMatch) {
      return {
        skill: partialMatch.skill,
        confidence: partialMatch.confidence * 0.8 // Penalty for partial match
      };
    }
  }

  return null;
}
```

**Key changes:**
1. Remove hardcoded `synonyms` object entirely
2. Use `normalizeSkillName()` from skills-service for alias resolution
3. Compare normalized forms for exact matching
4. Add 3+ character guard on partial matching to prevent false positives
5. Keep the 0.8 confidence penalty for partial matches
  </action>
  <verify>
- `grep -A5 "findMatchingSkill" functions/src/vector-search.ts` shows refactored method
- `grep "const synonyms" functions/src/vector-search.ts` returns nothing (removed)
- `grep "normalizeSkillName" functions/src/vector-search.ts` shows usage
- `npm run typecheck --prefix functions` passes (or tsc --noEmit)
  </verify>
  <done>
- Hardcoded synonyms object removed from findMatchingSkill
- normalizeSkillName used for target and candidate skill normalization
- Partial match protected with 3+ character guard
- Confidence penalty preserved for partial matches
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run typecheck --prefix functions` or `cd functions && npx tsc --noEmit`
2. Synonym removal: `grep "javascript.*js.*ecmascript" functions/src/vector-search.ts` returns nothing
3. Import present: `grep "skills-service" functions/src/vector-search.ts` shows import
4. Functional test (manual): Search for "JS" and verify JavaScript-related candidates appear
</verification>

<success_criteria>
- Hardcoded 6-entry synonyms map completely removed from vector-search.ts
- findMatchingSkill uses normalizeSkillName for all skill comparisons
- Partial match guard prevents short-term false positives (C matching Executive)
- TypeScript compiles without errors
- Skill matching now benefits from 200+ EllaAI aliases instead of 6 hardcoded ones
</success_criteria>

<output>
After completion, create `.planning/phases/05-skills-infrastructure/05-02-SUMMARY.md`
</output>
