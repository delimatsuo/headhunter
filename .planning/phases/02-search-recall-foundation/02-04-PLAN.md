---
phase: 02-search-recall-foundation
plan: 04
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
  - 02-03
files_modified:
  - functions/src/engines/legacy-engine.ts
autonomous: true

must_haves:
  truths:
    - "Tech stack filter converts to scoring with _tech_stack_score"
    - "Function title filter converts to scoring with _function_score"
    - "Career trajectory filter converts to scoring with _trajectory_score"
    - "MIN_SCORE_THRESHOLD removed or set to 0"
  artifacts:
    - path: "functions/src/engines/legacy-engine.ts"
      provides: "All remaining filters converted to scoring"
      contains: "_tech_stack_score"
  key_links:
    - from: "functions/src/engines/legacy-engine.ts"
      to: "retrieval_score calculation"
      via: "all _*_score fields"
      pattern: "_.*_score"
---

<objective>
Convert remaining hard filters (tech stack, function title, career trajectory, score threshold) to soft scoring signals.

Purpose: After Plans 02-03 handle level and specialty, 4 more filters remain. This plan completes the conversion, ensuring ALL filtering logic becomes scoring signals. The goal is zero exclusion at retrieval stage.

Output: All 7 exclusionary filters are now scoring signals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-search-recall-foundation/02-RESEARCH.md
@functions/src/engines/legacy-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert tech stack filter to scoring</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
Find the tech stack filtering section (around lines 246-292):
```typescript
if (isNodeSearch) {
    vectorPool = vectorPool.filter((c: any) => {
        // ... wrong stack detection
        return !(hasWrongStack && !hasRightStack);
    });
}
```

Replace with scoring logic:
```typescript
if (isNodeSearch) {
    vectorPool = vectorPool.map((c: any) => {
        const candidateId = c.candidate_id || c.id || '';
        const candidateSkills = pgSkills.get(candidateId) || [];

        // No skill data - neutral score
        if (candidateSkills.length === 0) {
            return { ...c, _tech_stack_score: 0.5 };
        }

        const candidateSkillsLower = candidateSkills.map((s: string) => s.toLowerCase());

        const hasWrongStack = wrongStackIndicators.some(ws =>
            candidateSkillsLower.some((cs: string) => cs.includes(ws))
        );

        const hasRightStack = rightStackIndicators.some(rs =>
            candidateSkillsLower.some((cs: string) => cs.includes(rs))
        );

        // Score based on stack match:
        // Right stack: 1.0
        // Both stacks (polyglot): 0.7
        // Neither: 0.5
        // Wrong stack only: 0.2
        let techScore: number;
        if (hasRightStack && !hasWrongStack) {
            techScore = 1.0;
        } else if (hasRightStack && hasWrongStack) {
            techScore = 0.7; // Polyglot developer
        } else if (!hasWrongStack) {
            techScore = 0.5; // Unknown
        } else {
            techScore = 0.2; // Wrong stack but Gemini can evaluate
        }

        return { ...c, _tech_stack_score: techScore };
    });

    console.log(`[LegacyEngine] Tech stack scoring applied (not filtered)`);
}
```
  </action>
  <verify>
- `grep -n "_tech_stack_score" functions/src/engines/legacy-engine.ts` shows the new field
  </verify>
  <done>
Tech stack filter is now a scoring signal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert function title exclusion to scoring</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
Find the function mismatch exclusion section (around lines 294-328):
```typescript
if (targetClassification.function === 'engineering') {
    vectorPool = vectorPool.filter((c: any) => {
        const title = (...).toLowerCase();
        if (!title) return true;
        return !excludedTitleKeywords.some(keyword => title.includes(keyword));
    });
}
```

Replace with scoring:
```typescript
if (targetClassification.function === 'engineering') {
    vectorPool = vectorPool.map((c: any) => {
        const title = (
            c.profile?.current_role ||
            c.searchable?.title_keywords?.[0] ||
            c.current_role ||
            ''
        ).toLowerCase();

        // No title - neutral
        if (!title) {
            return { ...c, _function_title_score: 0.5 };
        }

        // Check for excluded functions (PM, QA, etc.)
        const hasExcludedTitle = excludedTitleKeywords.some(keyword => title.includes(keyword));

        // Score: 1.0 for engineering titles, 0.2 for clearly non-engineering
        const functionScore = hasExcludedTitle ? 0.2 : 1.0;

        return { ...c, _function_title_score: functionScore };
    });

    console.log(`[LegacyEngine] Function title scoring applied (not filtered)`);
}
```
  </action>
  <verify>
- `grep -n "_function_title_score" functions/src/engines/legacy-engine.ts` shows the new field
  </verify>
  <done>
Function title exclusion is now a scoring signal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert career trajectory filter to scoring and remove MIN_SCORE_THRESHOLD</name>
  <files>functions/src/engines/legacy-engine.ts</files>
  <action>
1. Find the career trajectory filter (around lines 465-489):
```typescript
if (!isExecutiveSearch) {
    candidates = candidates.filter((c: any) => {
        const nominalLevel = (...).toLowerCase();
        if (!nominalLevel || nominalLevel === 'unknown') return true;
        return !levelsAboveTarget.includes(nominalLevel);
    });
}
```

Replace with scoring:
```typescript
if (!isExecutiveSearch) {
    const levelsAboveTarget = this.getLevelsAbove(targetClassification.level);

    candidates = candidates.map((c: any) => {
        const nominalLevel = (
            c.searchable?.level ||
            c.profile?.current_level ||
            c.metadata?.current_level ||
            c.current_level ||
            ''
        ).toLowerCase();

        // Unknown level - neutral
        if (!nominalLevel || nominalLevel === 'unknown') {
            return { ...c, _trajectory_score: 0.5 };
        }

        // Score based on stepping down potential:
        // Not stepping down: 1.0
        // Stepping down (overqualified): 0.4 (still possible, just less likely)
        const isSteppingDown = levelsAboveTarget.includes(nominalLevel);
        const trajectoryScore = isSteppingDown ? 0.4 : 1.0;

        return { ...c, _trajectory_score: trajectoryScore };
    });

    console.log(`[LegacyEngine] Trajectory scoring applied (not filtered)`);
}
```

2. Find and remove/disable the MIN_SCORE_THRESHOLD filter (around lines 616-627):
```typescript
// PHASE 2 FIX: Remove score threshold - let all candidates through
// The threshold was 30, now we allow all candidates to reach Gemini
// const MIN_SCORE_THRESHOLD = 30;
// candidates = candidates.filter((c: any) => {
//     return score >= MIN_SCORE_THRESHOLD;
// });
console.log(`[LegacyEngine] Score threshold REMOVED - all ${candidates.length} candidates pass through`);
```

Comment out the entire threshold block and add a log line.
  </action>
  <verify>
- `grep -n "_trajectory_score" functions/src/engines/legacy-engine.ts` shows the new field
- `grep -n "Score threshold REMOVED" functions/src/engines/legacy-engine.ts` shows the bypass
- `grep -n "MIN_SCORE_THRESHOLD = 30" functions/src/engines/legacy-engine.ts` should NOT appear (commented out)
  </verify>
  <done>
Career trajectory filter is now scoring, and MIN_SCORE_THRESHOLD is removed.
  </done>
</task>

</tasks>

<verification>
1. All 4 remaining filters converted to scoring:
   - Tech stack: _tech_stack_score
   - Function title: _function_title_score
   - Career trajectory: _trajectory_score
   - Score threshold: removed entirely
2. TypeScript compiles: `npm run typecheck --prefix functions`
3. No .filter() calls remain that exclude candidates based on any of the 7 criteria
4. Console logs show "scoring applied (not filtered)" for each
</verification>

<success_criteria>
1. Zero candidates excluded at retrieval stage (all filtering is scoring)
2. All score fields attached (_level_score, _specialty_score, _tech_stack_score, _function_title_score, _trajectory_score)
3. MIN_SCORE_THRESHOLD block is commented out
4. TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-recall-foundation/02-04-SUMMARY.md`
</output>
