---
phase: 02-search-recall-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/vector-search.ts
  - functions/src/pgvector-client.ts
  - services/hh-search-svc/src/config.ts
autonomous: true

must_haves:
  truths:
    - "Vector search retrieves 500+ candidates for typical queries"
    - "Similarity threshold is 0.25 or lower"
    - "Config can override threshold via environment variable"
  artifacts:
    - path: "functions/src/vector-search.ts"
      provides: "Lowered similarity threshold"
      contains: "similarityThreshold = 0.25"
    - path: "functions/src/pgvector-client.ts"
      provides: "Lowered default threshold in searchSimilar"
      contains: "similarityThreshold: number = 0.25"
    - path: "services/hh-search-svc/src/config.ts"
      provides: "Lowered minSimilarity config"
      contains: "SEARCH_MIN_SIMILARITY, 0.25"
  key_links:
    - from: "functions/src/vector-search.ts"
      to: "functions/src/pgvector-client.ts"
      via: "searchSimilar call"
      pattern: "searchSimilar.*similarityThreshold"
---

<objective>
Lower vector similarity thresholds across all search paths to enable broad retrieval.

Purpose: The current thresholds (0.5-0.7) are too restrictive, causing the retrieval stage to return only ~300 candidates. Lowering to 0.25 will allow 500-800 candidates to reach the scoring/reranking stages.

Output: Modified threshold constants and config defaults in three files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-search-recall-foundation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lower VectorSearchService threshold</name>
  <files>functions/src/vector-search.ts</files>
  <action>
In the `searchCandidates` method (around line 463), change:
```typescript
const similarityThreshold = 0.5; // Lowered from 0.7
```
to:
```typescript
const similarityThreshold = 0.25; // Broad recall - let scoring/reranking filter
```

Also update the default `limit` from 100 to 500 to fetch more candidates:
```typescript
const limit = query.limit || 500; // Increased for broad recall
```

And increase the fetchLimit multiplier (around line 466) from 1x to 2x:
```typescript
const fetchLimit = limit + offset; // Was: limit + offset, keep as is but limit is now 500
```
  </action>
  <verify>
- `grep -n "similarityThreshold = 0.25" functions/src/vector-search.ts` returns the modified line
- `grep -n "query.limit || 500" functions/src/vector-search.ts` returns the limit change
  </verify>
  <done>
VectorSearchService uses 0.25 threshold and fetches up to 500 candidates by default.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lower PgVectorClient default threshold</name>
  <files>functions/src/pgvector-client.ts</files>
  <action>
In the `searchSimilar` method signature (around line 331), change the default threshold:
```typescript
async searchSimilar(
  queryEmbedding: number[],
  similarityThreshold: number = 0.7,  // <-- Change this to 0.25
  ...
)
```

This ensures any code calling `searchSimilar` without an explicit threshold gets the broader recall.

Also add a console.log for debugging after the WHERE clause is built:
```typescript
console.log(`[PgVectorClient] searchSimilar: threshold=${similarityThreshold}, maxResults=${maxResults}`);
```
  </action>
  <verify>
- `grep -n "similarityThreshold: number = 0.25" functions/src/pgvector-client.ts` returns the modified signature
  </verify>
  <done>
PgVectorClient uses 0.25 default threshold, improving recall for all callers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Lower hh-search-svc config threshold</name>
  <files>services/hh-search-svc/src/config.ts</files>
  <action>
In the `search` config section (around line 236), change the minSimilarity default:
```typescript
minSimilarity: parseNumber(process.env.SEARCH_MIN_SIMILARITY, 0.45),
```
to:
```typescript
minSimilarity: parseNumber(process.env.SEARCH_MIN_SIMILARITY, 0.25),
```

This ensures the hh-search-svc microservice uses the same broad recall threshold.
  </action>
  <verify>
- `grep -n "SEARCH_MIN_SIMILARITY, 0.25" services/hh-search-svc/src/config.ts` returns the modified line
  </verify>
  <done>
hh-search-svc uses 0.25 threshold, consistent with functions layer.
  </done>
</task>

</tasks>

<verification>
1. All three files have threshold set to 0.25
2. TypeScript compiles without errors: `npm run typecheck --prefix functions && npm run typecheck --prefix services`
3. No hardcoded high thresholds remain: `grep -rn "similarityThreshold.*0\.[5-9]" functions/src/` should return no results
</verification>

<success_criteria>
1. Vector similarity threshold is 0.25 in all three locations
2. Default limit increased to 500 for broader retrieval
3. TypeScript compilation succeeds
4. SEARCH_MIN_SIMILARITY env var can still override at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-recall-foundation/02-01-SUMMARY.md`
</output>
