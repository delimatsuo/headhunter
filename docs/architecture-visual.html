<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headhunter System Architecture – Visual Map</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2a;
      --text: #e6eefc;
      --muted: #9fb3d1;
      --work: #22c55e;      /* working */
      --mis:  #f59e0b;      /* built but misaligned/not connected */
      --plan: #3b82f6;      /* planned */
      --nb:   #ef4444;      /* not built */
      --border: #1f2a44;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      color: var(--text); background: radial-gradient(1200px 800px at 10% -10%, #0f1730, #0b1220);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { color: var(--muted); margin: 0 0 20px; font-size: 14px; }
    .legend { display: flex; gap: 16px; align-items: center; margin: 12px 0 22px; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; background: #0f1a33; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.work { background: var(--work); }
    .dot.mis  { background: var(--mis); }
    .dot.plan { background: var(--plan); }
    .dot.nb   { background: var(--nb); }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(220px, 1fr));
      gap: 16px;
      align-items: start;
    }
    .col { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .col h2 { font-size: 15px; margin: 0 0 10px; color: #cfe0ff; letter-spacing: .2px; }
    .box { position: relative; background: #0f1830; border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; margin: 10px 0; }
    .box .title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .box .desc  { font-size: 12px; color: var(--muted); line-height: 1.35; }
    .box .status { position: absolute; top: 8px; right: 8px; font-size: 10px; padding: 3px 7px; border-radius: 999px; border: 1px solid var(--border); color: #011; }
    .work .status { background: rgba(34,197,94,.2); color: #caffd5; }
    .mis  .status { background: rgba(245,158,11,.2); color: #ffe7bd; }
    .plan .status { background: rgba(59,130,246,.2); color: #d7e7ff; }
    .nb   .status { background: rgba(239,68,68,.2); color: #ffd6d6; }

    .flow { margin: 22px 0 8px; color: var(--muted); font-size: 12px; }
    .arrow { color: #6ea8ff; }

    .notes {
      margin-top: 22px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px;
    }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .panel h3 { margin: 0 0 10px; font-size: 14px; color: #cfe0ff; }
    ul { margin: 8px 0 0 18px; padding: 0; }
    li { margin: 6px 0; font-size: 13px; color: var(--muted); }
    code { background: #0d152b; border: 1px solid var(--border); padding: 1px 6px; border-radius: 6px; color: #cfe0ff; }
    a { color: #9cc2ff; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Headhunter System Architecture – Visual Map</h1>
  <p class="sub">A high‑level view of data flow and components with build status (updated to single‑pass Qwen, unified search, and no‑mock policy).</p>

  <div class="legend">
    <span class="badge"><span class="dot work"></span> Built & Working</span>
    <span class="badge"><span class="dot mis"></span> Built but Misaligned / Not Connected</span>
    <span class="badge"><span class="dot plan"></span> Planned / In Progress</span>
    <span class="badge"><span class="dot nb"></span> Not Built</span>
  </div>

  <div class="grid">
    <!-- Column 1: Inputs -->
    <div class="col">
      <h2>Inputs</h2>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">CSV + Resume Files</div>
        <div class="desc">CSV, PDF/DOCX/TXT/Images (OCR) synced to GCS raw bucket.</div>
      </div>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Resume Extraction</div>
        <div class="desc">Multi‑format text extraction pipelines prepare inputs for AI.</div>
      </div>
    </div>

    <!-- Column 2: AI Processing -->
    <div class="col">
      <h2>AI Processing</h2>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Stage 1 – Together AI (Qwen 2.5 32B)</div>
        <div class="desc">Single‑pass enrichment (skills with confidence + evidence, trajectory, insights, <code>analysis_confidence</code>). Python async processors stream to Firestore. Model via <code>TOGETHER_MODEL_STAGE1</code>.</div>
      </div>
      <div class="box plan">
        <div class="status">in progress</div>
        <div class="title">JSON Repair + Schemas</div>
        <div class="desc">Validator + repair integrated; stabilizing targets (&lt;1% repair/quarantine). TDD modules in place; expanding coverage.</div>
      </div>
      <div class="box nb">
        <div class="status">not built</div>
        <div class="title">Stage 2 – Contextual Intelligence</div>
        <div class="desc">Optional second pass (e.g., Qwen 32B) for company/industry progression insights.</div>
      </div>
    </div>

    <!-- Column 3: Storage & Indexing -->
    <div class="col">
      <h2>Storage & Indexing</h2>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Firestore – Enhanced Profiles</div>
        <div class="desc">Structured candidate profiles stored for UI and APIs.</div>
      </div>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Embeddings Collection</div>
        <div class="desc"><code>candidate_embeddings</code> standardized; embedding text built from enriched profile; Vertex <code>text-embedding-004</code> baseline.</div>
      </div>
      <div class="box plan">
        <div class="status">planned</div>
        <div class="title">Cloud SQL + pgvector</div>
        <div class="desc">Target vector store for ANN search at 29k+ scale; service + index integration pending.</div>
      </div>
    </div>

    <!-- Column 4: APIs & Services -->
    <div class="col">
      <h2>APIs & Services</h2>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Firebase Functions</div>
        <div class="desc">CRUD, upload pipeline, unified skill‑aware search (composite ranking + <code>analysis_confidence</code> demotion). No mock fallbacks.</div>
      </div>
      <div class="box mis">
        <div class="status">guarded</div>
        <div class="title">Gemini Enrichment (Functions)</div>
        <div class="desc">Disabled by default; returns explicit error if called. Enrichment lives in Python/Together.</div>
      </div>
      <div class="box plan">
        <div class="status">in progress</div>
        <div class="title">Search Pipeline (Unified)</div>
        <div class="desc">ANN recall (pgvector planned) ∪ deterministic title/company recall → composite re‑rank (skill/conf/vec/exp) → optional low‑depth bucket for sparse profiles.</div>
      </div>
      <div class="box plan">
        <div class="status">planned</div>
        <div class="title">Cloud Run – Enrichment Worker</div>
        <div class="desc">Containerized Python worker with Pub/Sub orchestration for high throughput.</div>
      </div>
      <div class="box plan">
        <div class="status">in progress</div>
        <div class="title">Cloud Run – Vector Search API</div>
        <div class="desc">ANN service skeleton present; will query pgvector and re‑rank with structured signals. No mock embeddings; errors if not configured.</div>
      </div>
    </div>

    <!-- Column 5: UI & Access -->
    <div class="col">
      <h2>UI & Access</h2>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">React SPA (Firebase Auth)</div>
        <div class="desc">Deployed to Firebase Hosting. Clean list for Job Search; deep Candidate Page for full details.</div>
      </div>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Job Search (Minimal List)</div>
        <div class="desc">Top 50 (expandable). Row: name, current role @ company, years/level, score, freshness badge, LinkedIn. Low‑depth badge when applicable.</div>
      </div>
      <div class="box plan">
        <div class="status">planned</div>
        <div class="title">People Search (Direct)</div>
        <div class="desc">Search by name or LinkedIn URL; opens Candidate Page directly.</div>
      </div>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">Candidate Page (Detail)</div>
        <div class="desc">Full Skill Map (explicit + inferred with confidence + verification tags), compact timeline, resume freshness, LinkedIn link, evidence snippets.</div>
      </div>
      <div class="box plan">
        <div class="status">planned</div>
        <div class="title">Pre‑Interview Analysis (On‑Demand)</div>
        <div class="desc">Qwen‑generated summary, strengths, red flags, and signal chips; cached per candidate/version; generated on click.</div>
      </div>
      <div class="box work">
        <div class="status">working</div>
        <div class="title">LinkedIn + Freshness</div>
        <div class="desc">Show LinkedIn profile link and “Resume updated” date with freshness badge (Recent/Stale/Very stale). CTA to re‑upload when stale.</div>
      </div>
      <div class="box plan">
        <div class="status">planned</div>
        <div class="title">Admin & Lists</div>
        <div class="desc">Allowlist/roles management, shortlist save/export, richer rationale panels.</div>
      </div>
    </div>
  </div>

  <div class="flow">End‑to‑end flow: Inputs <span class="arrow">→</span> Qwen (Stage 1 single‑pass) <span class="arrow">→</span> Firestore + Embeddings <span class="arrow">→</span> APIs/Search <span class="arrow">→</span> UI</div>

  <div class="notes">
    <div class="panel">
      <h3>Recently Completed</h3>
      <ul>
        <li>Single‑pass Qwen (Stage 1) + <code>analysis_confidence</code> demotion in ranking.</li>
        <li>UI callable wiring fixed; richer search results returned to SPA.</li>
        <li>Functions cleanup; Gemini enrichment guarded/disabled by default.</li>
        <li>Embeddings standardized to <code>candidate_embeddings</code>; config centralization.</li>
        <li>No‑mock policy enforced (errors surfaced when services unavailable).</li>
        <li>JSON repair/schema modules added; integrated validator path.</li>
      </ul>
    </div>
    <div class="panel">
      <h3>Next Actions</h3>
      <ul>
        <li>Implement real Vertex client in Vector ANN service; add Dockerfile + deploy.</li>
        <li>Wire ANN service to pgvector; fetch profiles and re‑rank with structured signals.</li>
        <li>Harden JSON repair/validation (target &lt;1% repair/quarantine on 50‑candidate batch).</li>
        <li>SPA integration with ANN service; graceful error handling for service downtime.</li>
        <li>Docs: finalize deploy/runbooks and update diagrams for pgvector path.</li>
      </ul>
    </div>
  </div>

  <div class="notes" style="margin-top:0;">
    <div class="panel">
      <h3>Scoring Model (Unified Search)</h3>
      <ul>
        <li>Composite: <code>0.40×skill_match + 0.25×confidence + 0.25×vector_similarity + 0.10×experience</code>.</li>
        <li>Demotion: <code>overall_score *= (0.6 + 0.4 × analysis_confidence)</code> when available.</li>
        <li>Explainability: return top skills with confidence, rationale bullets, and summary.</li>
      </ul>
    </div>
    <div class="panel">
      <h3>Policies & Env Flags</h3>
      <ul>
        <li>No mock fallbacks in prod/staging; errors are surfaced to clients.</li>
        <li><code>TOGETHER_MODEL_STAGE1</code>: default <code>Qwen2.5-32B-Instruct</code>.</li>
        <li><code>EMBEDDING_PROVIDER</code>: <code>vertex</code> (prod) or <code>local</code> (dev‑only deterministic).</li>
        <li><code>ENABLE_GEMINI</code>: default <code>false</code>; enrichment path errors when disabled.</li>
        <li><code>USE_PGVECTOR</code>: toggles pgvector path for embeddings and ANN.</li>
      </ul>
    </div>
    <div class="panel">
      <h3>Recall Safeguards (Thin Profiles)</h3>
      <ul>
        <li>Dual recall: union ANN top‑K with deterministic title/company matches; then re‑rank.</li>
        <li>Deterministic boost: small score boost for exact title/company matches; raise low‑content floor.</li>
        <li>Optional bucket: “Potential matches (low profile depth)” to avoid losing sparse profiles.</li>
      </ul>
    </div>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h3>File Pointers</h3>
    <ul>
      <li>PRD: <code>.taskmaster/docs/prd.txt</code></li>
      <li>Handover: <code>docs/HANDOVER.md</code></li>
      <li>Architecture: <code>docs/CLOUD_ARCHITECTURE.md</code>, <code>ARCHITECTURE.md</code></li>
      <li>Vector ANN Spec: <code>docs/VECTOR_SEARCH_SERVICE.md</code></li>
      <li>Functions (APIs/Search): <code>functions/src/*.ts</code> (see <code>config.ts</code>, <code>vector-search.ts</code>)</li>
      <li>Processors (Together AI): <code>scripts/*together*</code>, <code>scripts/intelligent_skill_processor.py</code></li>
      <li>UI (SPA): <code>headhunter-ui/src/*</code></li>
    </ul>
  </div>
</body>
</html>
